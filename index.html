<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Professional Binance Futures Trading Dashboard">
    <meta name="theme-color" content="#6366f1">
    <title>NeoTrade | Binance Futures Pro</title>
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“ˆ</text></svg>">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap">
    <style>
        /* All your existing CSS styles remain exactly the same */
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #818cf8;
            --success: #10b981;
            --success-dark: #059669;
            --danger: #ef4444;
            --danger-dark: #dc2626;
            --warning: #f59e0b;
            --warning-dark: #d97706;
            --info: #06b6d4;
            --info-dark: #0891b2;
            --dark-0: #0f172a;
            --dark-1: #1e293b;
            --dark-2: #334155;
            --dark-3: #475569;
            --light-0: #f8fafc;
            --light-1: #f1f5f9;
            --light-2: #e2e8f0;
            --light-3: #cbd5e1;
            --accent: #8b5cf6;
            --accent-dark: #7c3aed;
            --gradient-primary: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            --gradient-success: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            --gradient-danger: linear-gradient(135deg, #ef4444 0%, #f87171 100%);
            --gradient-warning: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
            --gradient-dark: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --shadow-glow: 0 0 20px rgba(99, 102, 241, 0.15);
            --border-radius-sm: 6px;
            --border-radius-md: 10px;
            --border-radius-lg: 16px;
            --border-radius-xl: 24px;
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-normal: 250ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 350ms cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--dark-0);
            color: var(--light-1);
            min-height: 100vh;
            overflow-x: hidden;
            background-image: 
                radial-gradient(at 10% 20%, rgba(99, 102, 241, 0.05) 0px, transparent 50%),
                radial-gradient(at 90% 80%, rgba(139, 92, 246, 0.05) 0px, transparent 50%);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--dark-1);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--dark-3);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--primary);
        }

        /* Layout */
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 0 24px;
        }

        /* Header */
        .header {
            padding: 20px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            margin-bottom: 32px;
            position: sticky;
            top: 0;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            z-index: 100;
        }

        .header-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 32px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.75rem;
            font-weight: 800;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .logo-icon {
            width: 40px;
            height: 40px;
            background: var(--gradient-primary);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.25rem;
        }

        .header-content {
            display: flex;
            align-items: center;
            flex: 1;
            gap: 32px;
        }

        .search-container {
            flex: 1;
            max-width: 500px;
            position: relative;
        }

        .search-wrapper {
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 14px 20px 14px 48px;
            background: var(--dark-1);
            border: 2px solid var(--dark-2);
            border-radius: var(--border-radius-lg);
            color: var(--light-0);
            font-size: 15px;
            transition: all var(--transition-normal);
            font-weight: 500;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: var(--shadow-glow);
        }

        .search-icon {
            position: absolute;
            left: 18px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--light-3);
            font-size: 16px;
        }

        .header-nav {
            display: flex;
            gap: 8px;
            background: var(--dark-1);
            padding: 8px;
            border-radius: var(--border-radius-lg);
            border: 1px solid var(--dark-2);
        }

        .nav-btn {
            padding: 10px 20px;
            background: transparent;
            border: none;
            color: var(--light-3);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
            border-radius: var(--border-radius-md);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-btn:hover {
            background: var(--dark-2);
            color: var(--light-1);
        }

        .nav-btn.active {
            background: var(--primary);
            color: white;
            box-shadow: var(--shadow-glow);
        }

        .search-results {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            right: 0;
            background: var(--dark-1);
            border-radius: var(--border-radius-lg);
            border: 1px solid var(--dark-2);
            box-shadow: var(--shadow-xl);
            max-height: 400px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            animation: slideDown 0.2s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .search-result-item {
            padding: 16px 20px;
            border-bottom: 1px solid var(--dark-2);
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .search-result-item:hover {
            background: var(--dark-2);
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .search-result-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .search-result-symbol {
            font-weight: 700;
            font-size: 15px;
            color: var(--light-0);
        }

        .search-result-name {
            font-size: 13px;
            color: var(--light-3);
        }

        .search-result-price {
            font-weight: 600;
            font-size: 15px;
        }

        .search-result-change {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 20px;
            font-weight: 600;
        }

        .search-result-change.positive {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
        }

        .search-result-change.negative {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
        }

        .header-stats {
            display: flex;
            gap: 24px;
            align-items: center;
        }

        .live-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(16, 185, 129, 0.1);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .live-dot {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Dashboard Stats */
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--dark-1);
            border-radius: var(--border-radius-lg);
            padding: 24px;
            border: 1px solid var(--dark-2);
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-xl);
            border-color: var(--primary-light);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }

        .stat-card.total-pnl::before {
            background: var(--gradient-primary);
        }

        .stat-card.active-trades::before {
            background: var(--gradient-warning);
        }

        .stat-card.watchlist::before {
            background: var(--gradient-success);
        }

        .stat-card.market-status::before {
            background: var(--gradient-danger);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .stat-title {
            font-size: 14px;
            color: var(--light-3);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .stat-card.total-pnl .stat-icon {
            background: rgba(99, 102, 241, 0.15);
            color: var(--primary);
        }

        .stat-card.active-trades .stat-icon {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
        }

        .stat-card.watchlist .stat-icon {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
        }

        .stat-card.market-status .stat-icon {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
        }

        .stat-value {
            font-size: 32px;
            font-weight: 800;
            margin-bottom: 8px;
            line-height: 1;
        }

        .positive {
            color: var(--success);
        }

        .negative {
            color: var(--danger);
        }

        .stat-change {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--light-3);
        }

        .stat-change-value {
            font-weight: 700;
        }

        .stat-change-value.positive {
            color: var(--success);
        }

        .stat-change-value.negative {
            color: var(--danger);
        }

        /* Tabs */
        .tabs-container {
            background: var(--dark-1);
            border-radius: var(--border-radius-lg);
            border: 1px solid var(--dark-2);
            margin-bottom: 32px;
            overflow: hidden;
        }

        .tabs-header {
            display: flex;
            background: var(--dark-2);
            padding: 0 8px;
        }

        .tab-btn {
            padding: 18px 32px;
            background: transparent;
            border: none;
            color: var(--light-3);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
            position: relative;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tab-btn:hover {
            color: var(--light-1);
        }

        .tab-btn.active {
            color: var(--light-0);
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 16px;
            right: 16px;
            height: 3px;
            background: var(--primary);
            border-radius: 3px 3px 0 0;
        }

        .tab-content {
            display: none;
            padding: 32px;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Market Tables */
        .market-section {
            background: var(--dark-1);
            border-radius: var(--border-radius-lg);
            border: 1px solid var(--dark-2);
            margin-bottom: 32px;
            overflow: hidden;
        }

        .section-header {
            padding: 24px;
            border-bottom: 1px solid var(--dark-2);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-title {
            font-size: 20px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .section-title i {
            color: var(--primary);
        }

        .section-controls {
            display: flex;
            gap: 12px;
        }

        .search-control {
            padding: 10px 16px;
            background: var(--dark-2);
            border: 1px solid var(--dark-3);
            border-radius: var(--border-radius-md);
            color: var(--light-1);
            font-size: 14px;
            min-width: 200px;
        }

        .search-control:focus {
            outline: none;
            border-color: var(--primary);
        }

        .table-container {
            overflow-x: auto;
        }

        .market-table {
            width: 100%;
            border-collapse: collapse;
        }

        .market-table th {
            padding: 16px 20px;
            text-align: left;
            font-size: 13px;
            font-weight: 600;
            color: var(--light-3);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: var(--dark-2);
            border-bottom: 1px solid var(--dark-3);
            white-space: nowrap;
        }

        .market-table td {
            padding: 20px;
            border-bottom: 1px solid var(--dark-2);
            font-weight: 500;
        }

        .market-table tr:hover {
            background: var(--dark-2);
        }

        .market-table tr:last-child td {
            border-bottom: none;
        }

        .coin-cell {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .coin-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--dark-3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            color: var(--light-0);
        }

        .coin-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .coin-symbol {
            font-weight: 700;
            font-size: 15px;
        }

        .coin-name {
            font-size: 13px;
            color: var(--light-3);
        }

        .price-cell {
            font-weight: 700;
            font-size: 15px;
        }

        .change-cell {
            font-weight: 700;
            font-size: 15px;
        }

        .change-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .change-badge.positive {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
        }

        .change-badge.negative {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
        }

        .high-low-progress {
            width: 100%;
            height: 6px;
            background: var(--dark-3);
            border-radius: 3px;
            overflow: hidden;
            position: relative;
            margin: 8px 0;
        }

        .current-position {
            position: absolute;
            width: 12px;
            height: 12px;
            background: var(--light-0);
            border: 2px solid var(--primary);
            border-radius: 50%;
            top: -3px;
            transform: translateX(-50%);
            z-index: 2;
        }

        .high-low-fill {
            position: absolute;
            height: 100%;
            background: var(--primary);
            border-radius: 3px;
        }

        .high-low-text {
            font-size: 12px;
            color: var(--light-3);
            display: flex;
            justify-content: space-between;
            margin-top: 4px;
        }

        .actions-cell {
            display: flex;
            gap: 8px;
        }

        .action-btn {
            padding: 8px 16px;
            border-radius: var(--border-radius-md);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .action-btn.long {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
        }

        .action-btn.long:hover {
            background: var(--success);
            color: white;
        }

        .action-btn.short {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
        }

        .action-btn.short:hover {
            background: var(--danger);
            color: white;
        }

        .action-btn.watchlist {
            background: rgba(99, 102, 241, 0.15);
            color: var(--primary);
            padding: 8px;
        }

        .action-btn.watchlist:hover {
            background: var(--primary);
            color: white;
        }

        .action-btn.track {
            background: rgba(139, 92, 246, 0.15);
            color: var(--accent);
            padding: 8px 12px;
        }

        .action-btn.track:hover {
            background: var(--accent);
            color: white;
        }

        .action-btn.tracking {
            background: var(--accent);
            color: white;
            padding: 8px 12px;
        }

        /* NEW: Rejection Indicator */
        .rejection-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
            animation: pulse 1.5s infinite;
        }

        .rejection-indicator.warning {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
        }

        /* Trading Desk */
        .trading-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 32px;
        }

        @media (max-width: 1200px) {
            .trading-container {
                grid-template-columns: 1fr;
            }
        }

        /* Compact Active Trades */
        .active-trades-compact {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-height: 600px;
            overflow-y: auto;
            padding-right: 8px;
        }

        .trade-row {
            display: grid;
            grid-template-columns: auto 1fr repeat(5, auto);
            align-items: center;
            gap: 16px;
            padding: 16px;
            background: var(--dark-2);
            border-radius: var(--border-radius-md);
            border-left: 4px solid var(--success);
            transition: all var(--transition-fast);
            min-width: 0;
        }

        .trade-row:hover {
            background: var(--dark-1);
            transform: translateX(4px);
        }

        .trade-row.short {
            border-left-color: var(--danger);
        }

        .trade-row-symbol {
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 120px;
        }

        .trade-row-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--dark-3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 12px;
            color: var(--light-0);
            flex-shrink: 0;
        }

        .trade-row-symbol-text {
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        .trade-row-symbol-name {
            font-weight: 700;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .trade-row-leverage {
            font-size: 11px;
            color: var(--light-3);
            background: rgba(99, 102, 241, 0.1);
            padding: 2px 6px;
            border-radius: 10px;
        }

        .trade-row-side {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            white-space: nowrap;
        }

        .trade-row-side.long {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
        }

        .trade-row-side.short {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
        }

        .trade-row-prices {
            display: flex;
            flex-direction: column;
            gap: 2px;
            min-width: 120px;
        }

        .trade-row-price {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
        }

        .trade-row-price-label {
            color: var(--light-3);
        }

        .trade-row-price-value {
            font-weight: 600;
        }

        .trade-row-pnl {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            min-width: 100px;
        }

        .trade-row-pnl-value {
            font-weight: 700;
            font-size: 14px;
        }

        .trade-row-pnl-value.positive {
            color: var(--success);
        }

        .trade-row-pnl-value.negative {
            color: var(--danger);
        }

        .trade-row-pnl-percent {
            font-size: 11px;
            color: var(--light-3);
            margin-top: 2px;
        }

        .trade-row-progress {
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-width: 100px;
        }

        .trade-row-progress-bar {
            height: 6px;
            background: var(--dark-3);
            border-radius: 3px;
            overflow: hidden;
            position: relative;
        }

        .trade-row-progress-fill {
            height: 100%;
            background: var(--primary);
            border-radius: 3px;
        }

        .trade-row-progress-labels {
            display: flex;
            justify-content: space-between;
            font-size: 10px;
            color: var(--light-3);
        }

        .trade-row-actions {
            display: flex;
            gap: 6px;
            min-width: 100px;
        }

        .trade-row-action-btn {
            padding: 6px 12px;
            border-radius: var(--border-radius-sm);
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
        }

        .trade-row-action-btn.close {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
        }

        .trade-row-action-btn.close:hover {
            background: var(--danger);
            color: white;
        }

        .trade-row-action-btn.details {
            background: rgba(99, 102, 241, 0.15);
            color: var(--primary);
        }

        .trade-row-action-btn.details:hover {
            background: var(--primary);
            color: white;
        }

        /* Trade Form */
        .trade-form {
            background: var(--dark-1);
            border-radius: var(--border-radius-lg);
            border: 1px solid var(--dark-2);
            padding: 32px;
        }

        .form-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .form-title {
            font-size: 20px;
            font-weight: 700;
        }

        .order-type-selector {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 12px;
            margin-bottom: 24px;
        }

        .order-type-btn {
            padding: 16px;
            background: var(--dark-2);
            border: 2px solid var(--dark-3);
            border-radius: var(--border-radius-md);
            color: var(--light-1);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .order-type-btn:hover {
            border-color: var(--primary);
        }

        .order-type-btn.active {
            background: rgba(99, 102, 241, 0.15);
            border-color: var(--primary);
            color: var(--primary);
        }

        .margin-mode-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 24px;
        }

        .margin-mode-btn {
            padding: 12px;
            background: var(--dark-2);
            border: 2px solid var(--dark-3);
            border-radius: var(--border-radius-md);
            color: var(--light-1);
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .margin-mode-btn:hover {
            border-color: var(--warning);
        }

        .margin-mode-btn.active {
            background: rgba(245, 158, 11, 0.15);
            border-color: var(--warning);
            color: var(--warning);
        }

        .margin-info {
            display: flex;
            justify-content: space-between;
            background: rgba(245, 158, 11, 0.05);
            padding: 12px 16px;
            border-radius: var(--border-radius-md);
            margin-bottom: 20px;
            font-size: 13px;
        }

        .margin-info-label {
            color: var(--light-3);
        }

        .margin-info-value {
            font-weight: 600;
            color: var(--warning);
        }

        .selected-symbol {
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(99, 102, 241, 0.15);
            padding: 12px 20px;
            border-radius: var(--border-radius-md);
            margin-bottom: 24px;
        }

        .selected-symbol-info {
            flex: 1;
        }

        .selected-symbol-name {
            font-weight: 700;
            font-size: 16px;
        }

        .selected-symbol-price {
            font-size: 14px;
            color: var(--light-3);
        }

        .selected-symbol-change {
            font-weight: 600;
            font-size: 14px;
        }

        .selected-symbol-change.positive {
            color: var(--success);
        }

        .selected-symbol-change.negative {
            color: var(--danger);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            .order-type-selector {
                grid-template-columns: 1fr;
            }
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            font-weight: 600;
            color: var(--light-3);
        }

        .form-control {
            width: 100%;
            padding: 14px 16px;
            background: var(--dark-2);
            border: 1px solid var(--dark-3);
            border-radius: var(--border-radius-md);
            color: var(--light-0);
            font-size: 15px;
            font-weight: 500;
            transition: all var(--transition-fast);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .form-control.select {
            cursor: pointer;
        }

        .slider-container {
            position: relative;
            padding: 8px 0;
        }

        .slider-value {
            position: absolute;
            top: -10px;
            right: 0;
            background: var(--primary);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 700;
        }

        .slider {
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            appearance: none;
            background: var(--dark-3);
            border-radius: 3px;
            outline: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--primary);
            cursor: pointer;
            border: 3px solid var(--dark-1);
            box-shadow: var(--shadow-md);
        }

        /* Fee Display */
        .fee-display {
            background: rgba(245, 158, 11, 0.05);
            border: 1px solid rgba(245, 158, 11, 0.2);
            border-radius: var(--border-radius-md);
            padding: 16px;
            margin: 20px 0;
        }

        .fee-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .fee-row:last-child {
            margin-bottom: 0;
            font-weight: 600;
            color: var(--warning);
            border-top: 1px solid rgba(245, 158, 11, 0.2);
            padding-top: 8px;
            margin-top: 8px;
        }

        .fee-label {
            color: var(--light-3);
        }

        .fee-value {
            font-weight: 500;
        }

        .btn-group {
            display: flex;
            gap: 16px;
            margin-top: 32px;
        }

        .btn {
            padding: 16px 32px;
            border-radius: var(--border-radius-md);
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all var(--transition-normal);
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
        }

        .btn-success {
            background: var(--gradient-success);
            color: white;
        }

        .btn-danger {
            background: var(--gradient-danger);
            color: white;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid var(--dark-3);
            color: var(--light-1);
        }

        .btn-outline:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        /* Reset All Button */
        .reset-all-btn {
            margin-top: 32px;
            padding: 16px 32px;
            width: 100%;
            background: var(--gradient-danger);
            color: white;
            border: none;
            border-radius: var(--border-radius-md);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-normal);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .reset-all-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            background: var(--danger);
        }

        .reset-all-btn:active {
            transform: translateY(0);
        }

        .reset-all-btn i {
            font-size: 18px;
        }

        /* Save Settings Button */
        .save-settings-btn {
            margin-top: 16px;
            padding: 16px 32px;
            width: 100%;
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: var(--border-radius-md);
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-normal);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .save-settings-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .save-settings-btn:active {
            transform: translateY(0);
        }

        .save-settings-btn i {
            font-size: 18px;
        }

        /* Active Trades */
        .active-trades {
            background: var(--dark-1);
            border-radius: var(--border-radius-lg);
            border: 1px solid var(--dark-2);
            padding: 32px;
            max-height: 800px;
        }

        /* Tracked Prices Display - REDESIGNED */
        .tracked-prices {
            background: rgba(139, 92, 246, 0.08);
            border-radius: var(--border-radius-md);
            padding: 20px;
            margin-top: 12px;
            border: 1px solid rgba(139, 92, 246, 0.2);
        }

        .tracked-prices-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-top: 16px;
        }

        .tracked-price-item {
            background: rgba(139, 92, 246, 0.12);
            padding: 16px;
            border-radius: var(--border-radius-md);
            text-align: center;
            border: 1px solid rgba(139, 92, 246, 0.2);
            transition: all var(--transition-fast);
        }

        .tracked-price-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
            background: rgba(139, 92, 246, 0.15);
        }

        .tracked-price-label {
            font-size: 12px;
            color: var(--light-3);
            margin-bottom: 6px;
            font-weight: 600;
        }

        .tracked-price-value {
            font-weight: 700;
            font-size: 16px;
            color: var(--light-0);
            margin-bottom: 4px;
        }

        .tracked-price-diff {
            font-size: 11px;
            margin-top: 6px;
            font-weight: 600;
        }

        .tracked-price-diff.positive {
            color: var(--success);
        }

        .tracked-price-diff.negative {
            color: var(--danger);
        }

        /* Enhanced tracking stats */
        .tracking-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin: 16px 0;
        }

        .tracking-stat-item {
            background: rgba(139, 92, 246, 0.1);
            padding: 12px;
            border-radius: var(--border-radius-sm);
            text-align: center;
            border: 1px solid rgba(139, 92, 246, 0.15);
        }

        .tracking-stat-label {
            font-size: 11px;
            color: var(--light-3);
            margin-bottom: 4px;
            font-weight: 600;
        }

        .tracking-stat-value {
            font-size: 13px;
            font-weight: 700;
        }

        .tracking-stat-price {
            font-size: 11px;
            color: var(--light-2);
            margin-top: 2px;
        }

        .tracking-stat-value.positive {
            color: var(--success);
        }

        .tracking-stat-value.negative {
            color: var(--danger);
        }

        /* Quick trade buttons in tracking panel */
        .tracked-trade-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 16px;
        }

        .tracked-trade-btn {
            padding: 10px;
            border-radius: var(--border-radius-sm);
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .tracked-trade-btn.long {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .tracked-trade-btn.long:hover {
            background: var(--success);
            color: white;
        }

        .tracked-trade-btn.short {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .tracked-trade-btn.short:hover {
            background: var(--danger);
            color: white;
        }

        /* Movement indicators */
        .movement-indicator {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 10px;
            border-radius: var(--border-radius-sm);
            font-size: 12px;
            margin: 4px 0;
        }

        .movement-indicator.up {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .movement-indicator.down {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .movement-value {
            font-weight: 700;
        }

        /* Current vs Tracked Price Display - REDESIGNED */
        .current-vs-tracked {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding: 12px 16px;
            background: rgba(139, 92, 246, 0.1);
            border-radius: var(--border-radius-md);
            border: 1px solid rgba(139, 92, 246, 0.2);
        }

        .current-price-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .current-price-label {
            font-size: 12px;
            color: var(--light-3);
            font-weight: 600;
        }

        .current-price-value {
            font-size: 14px;
            font-weight: 700;
            color: var(--light-0);
        }

        .price-diff {
            font-size: 12px;
            padding: 4px 10px;
            border-radius: 12px;
            font-weight: 700;
            background: rgba(139, 92, 246, 0.2);
        }

        .price-diff.positive {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
        }

        .price-diff.negative {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }

        /* Alerts */
        .alert {
            position: fixed;
            top: 32px;
            right: 32px;
            padding: 20px 24px;
            border-radius: var(--border-radius-lg);
            background: var(--dark-1);
            border-left: 4px solid var(--primary);
            box-shadow: var(--shadow-xl);
            display: none;
            align-items: center;
            gap: 16px;
            z-index: 1000;
            max-width: 400px;
            animation: slideInRight 0.3s ease;
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .alert.success {
            border-left-color: var(--success);
        }

        .alert.warning {
            border-left-color: var(--warning);
        }

        .alert.danger {
            border-left-color: var(--danger);
        }

        .alert-icon {
            font-size: 24px;
        }

        .alert.success .alert-icon {
            color: var(--success);
        }

        .alert.warning .alert-icon {
            color: var(--warning);
        }

        .alert.danger .alert-icon {
            color: var(--danger);
        }

        .alert-content {
            flex: 1;
        }

        .alert-title {
            font-weight: 700;
            margin-bottom: 4px;
        }

        .alert-message {
            font-size: 14px;
            color: var(--light-3);
        }

        .alert-close {
            background: none;
            border: none;
            color: var(--light-3);
            cursor: pointer;
            font-size: 18px;
            padding: 4px;
        }

        /* Loading States */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px;
            gap: 20px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--dark-2);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: var(--light-3);
            font-size: 15px;
        }

        /* Settings */
        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
        }

        .setting-item {
            background: var(--dark-1);
            border-radius: var(--border-radius-lg);
            padding: 24px;
            border: 1px solid var(--dark-2);
        }

        .setting-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .setting-icon {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: rgba(99, 102, 241, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-size: 18px;
        }

        .setting-title {
            font-size: 16px;
            font-weight: 700;
        }

        .setting-controls {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .setting-label {
            font-size: 14px;
            color: var(--light-1);
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider-switch {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--dark-3);
            transition: .4s;
            border-radius: 34px;
        }

        .slider-switch:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider-switch {
            background-color: var(--primary);
        }

        input:checked + .slider-switch:before {
            transform: translateX(24px);
        }

        /* Trade History */
        .trade-history-filters {
            display: flex;
            gap: 12px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .filter-select {
            padding: 10px 16px;
            background: var(--dark-2);
            border: 1px solid var(--dark-3);
            border-radius: var(--border-radius-md);
            color: var(--light-1);
            font-size: 14px;
            min-width: 150px;
        }

        .trade-history-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .history-stat {
            background: var(--dark-2);
            padding: 16px;
            border-radius: var(--border-radius-md);
            text-align: center;
        }

        .history-stat-value {
            font-size: 24px;
            font-weight: 800;
            margin-bottom: 4px;
        }

        .history-stat-label {
            font-size: 12px;
            color: var(--light-3);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .trade-history-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 24px;
        }

        .trade-history-table th {
            padding: 16px;
            text-align: left;
            font-size: 13px;
            font-weight: 600;
            color: var(--light-3);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: var(--dark-2);
            border-bottom: 1px solid var(--dark-3);
        }

        .trade-history-table td {
            padding: 16px;
            border-bottom: 1px solid var(--dark-2);
            font-weight: 500;
        }

        .trade-history-table tr:hover {
            background: var(--dark-2);
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-badge.closed_tp {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
        }

        .status-badge.closed_sl {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
        }

        .status-badge.closed_manual {
            background: rgba(99, 102, 241, 0.15);
            color: var(--primary);
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .header-container {
                flex-direction: column;
                gap: 20px;
            }
            
            .header-content {
                flex-direction: column;
                width: 100%;
                gap: 20px;
            }
            
            .search-container {
                max-width: 100%;
                order: 1;
            }
            
            .header-nav {
                order: 2;
                width: 100%;
                justify-content: center;
                flex-wrap: wrap;
            }
            
            .header-stats {
                order: 3;
                width: 100%;
                justify-content: center;
            }
            
            .trade-row {
                grid-template-columns: auto 1fr repeat(3, auto);
                gap: 12px;
            }
            
            .trade-row-progress,
            .trade-row-actions {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 16px;
            }
            
            .tabs-header {
                overflow-x: auto;
                white-space: nowrap;
            }
            
            .tab-btn {
                padding: 16px 24px;
            }
            
            .section-header {
                flex-direction: column;
                gap: 16px;
                align-items: stretch;
            }
            
            .btn {
                padding: 14px 24px;
            }
            
            .save-settings-btn {
                padding: 14px 24px;
            }
            
            .tracked-prices-row {
                grid-template-columns: 1fr;
            }
            
            .trade-row {
                grid-template-columns: 1fr;
                gap: 8px;
            }
            
            .margin-mode-selector {
                grid-template-columns: 1fr;
            }
        }

        /* PNL Animation */
        @keyframes pnlFlash {
            0% { background-color: transparent; }
            50% { background-color: rgba(16, 185, 129, 0.1); }
            100% { background-color: transparent; }
        }

        .pnl-flash {
            animation: pnlFlash 1s ease;
        }

        /* Volume indicator in tables */
        .volume-bar {
            height: 4px;
            background: var(--dark-3);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 4px;
            position: relative;
        }

        .volume-fill {
            height: 100%;
            background: var(--primary);
            border-radius: 2px;
        }

        /* Profit/Loss distribution */
        .distribution-bar {
            display: flex;
            height: 6px;
            border-radius: 3px;
            overflow: hidden;
            margin: 8px 0;
        }

        .distribution-profit {
            background: var(--success);
        }

        .distribution-loss {
            background: var(--danger);
        }

        /* Trading stats */
        .trading-stats {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .trading-stat {
            background: var(--dark-2);
            padding: 16px;
            border-radius: var(--border-radius-md);
            text-align: center;
        }

        .trading-stat-value {
            font-size: 24px;
            font-weight: 800;
            margin-bottom: 4px;
        }

        .trading-stat-label {
            font-size: 12px;
            color: var(--light-3);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Price distance indicators */
        .distance-indicator {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: 600;
            margin-top: 4px;
            display: inline-block;
        }

        .distance-from-high {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
        }

        .distance-from-low {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 60px 32px;
            color: var(--light-3);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .empty-state-description {
            font-size: 14px;
            margin-bottom: 24px;
        }

        /* NEW STYLES FOR STOP LIMIT ORDERS */
        .stop-limit-group {
            background: rgba(245, 158, 11, 0.05);
            border: 1px solid rgba(245, 158, 11, 0.2);
            border-radius: var(--border-radius-md);
            padding: 16px;
            margin: 20px 0;
            display: none;
        }

        .stop-limit-group.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .stop-limit-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            color: var(--warning);
        }

        .stop-limit-header i {
            font-size: 18px;
        }

        .stop-limit-info {
            font-size: 12px;
            color: var(--light-3);
            margin-bottom: 12px;
            padding: 8px;
            background: rgba(245, 158, 11, 0.1);
            border-radius: var(--border-radius-sm);
        }

        /* Movement visualization */
        .movement-chart {
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 20px;
            margin: 12px 0;
            position: relative;
        }

        .movement-line {
            flex: 1;
            height: 2px;
            background: var(--dark-3);
            position: relative;
        }

        .movement-current {
            position: absolute;
            width: 8px;
            height: 8px;
            background: var(--primary);
            border: 2px solid white;
            border-radius: 50%;
            top: -3px;
            transform: translateX(-50%);
            z-index: 2;
        }

        .movement-tracked {
            position: absolute;
            width: 6px;
            height: 6px;
            background: var(--accent);
            border-radius: 50%;
            top: -2px;
            transform: translateX(-50%);
            z-index: 1;
        }

        .movement-long {
            position: absolute;
            width: 4px;
            height: 4px;
            background: var(--success);
            border-radius: 50%;
            top: -1px;
            transform: translateX(-50%);
        }

        .movement-short {
            position: absolute;
            width: 4px;
            height: 4px;
            background: var(--danger);
            border-radius: 50%;
            top: -1px;
            transform: translateX(-50%);
        }

        .movement-labels {
            display: flex;
            justify-content: space-between;
            font-size: 9px;
            color: var(--light-3);
            margin-top: 4px;
        }

        /* Stop limit badge */
        .stop-limit-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }

        /* Order status indicators */
        .order-status {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-left: 8px;
        }

        .order-status.pending {
            background: rgba(245, 158, 11, 0.15);
            color: var(--warning);
        }

        .order-status.filled {
            background: rgba(16, 185, 129, 0.15);
            color: var(--success);
        }

        .order-status.cancelled {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
        }

        /* NEW: Tracked header */
        .tracked-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(139, 92, 246, 0.2);
        }

        .tracked-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 700;
            color: var(--accent);
            font-size: 14px;
        }

        .tracked-time {
            font-size: 11px;
            color: var(--light-3);
        }

        /* NEW: CLOSE BUTTON for trades */
        .close-trade-btn {
            background: rgba(239, 68, 68, 0.15);
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, 0.3);
            padding: 6px 12px;
            border-radius: var(--border-radius-sm);
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
        }

        .close-trade-btn:hover {
            background: var(--danger);
            color: white;
        }

        /* NEW: Price display in tracking */
        .price-with-percent {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .price-main {
            font-weight: 700;
            font-size: 14px;
            color: var(--light-0);
        }

        .price-percent {
            font-size: 11px;
            font-weight: 600;
        }

        .price-percent.positive {
            color: var(--success);
        }

        .price-percent.negative {
            color: var(--danger);
        }

        /* NEW: Improved movement stats */
        .movement-stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin: 12px 0;
        }

        .movement-stat {
            background: rgba(139, 92, 246, 0.08);
            padding: 10px;
            border-radius: var(--border-radius-sm);
            border: 1px solid rgba(139, 92, 246, 0.15);
        }

        .movement-stat-label {
            font-size: 10px;
            color: var(--light-3);
            margin-bottom: 4px;
            font-weight: 600;
        }

        .movement-stat-percent {
            font-size: 12px;
            font-weight: 700;
            margin-bottom: 2px;
        }

        .movement-stat-price {
            font-size: 10px;
            color: var(--light-2);
        }

        .movement-stat-percent.positive {
            color: var(--success);
        }

        .movement-stat-percent.negative {
            color: var(--danger);
        }

        /* Install Prompt */
        .install-prompt {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--dark-1);
            border: 1px solid var(--dark-2);
            border-radius: var(--border-radius-lg);
            padding: 20px;
            box-shadow: var(--shadow-xl);
            z-index: 1000;
            max-width: 350px;
            animation: slideInUp 0.3s ease;
            display: none;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .install-prompt-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .install-prompt-icon {
            width: 40px;
            height: 40px;
            background: var(--gradient-primary);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
        }

        .install-prompt-title {
            font-weight: 700;
            font-size: 16px;
        }

        .install-prompt-description {
            color: var(--light-3);
            font-size: 14px;
            margin-bottom: 16px;
        }

        .install-prompt-actions {
            display: flex;
            gap: 12px;
        }

        .install-prompt-close {
            position: absolute;
            top: 12px;
            right: 12px;
            background: none;
            border: none;
            color: var(--light-3);
            cursor: pointer;
            font-size: 16px;
            padding: 4px;
        }

        /* Connection Status */
        .connection-status {
            position: fixed;
            bottom: 24px;
            left: 24px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            z-index: 999;
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--dark-1);
            border: 1px solid var(--dark-2);
            box-shadow: var(--shadow-md);
        }

        .connection-status.online {
            color: var(--success);
        }

        .connection-status.offline {
            color: var(--warning);
        }

        .connection-status.error {
            color: var(--danger);
        }

        .connection-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .connection-dot.online {
            background: var(--success);
            animation: pulse 2s infinite;
        }

        .connection-dot.offline {
            background: var(--warning);
        }

        .connection-dot.error {
            background: var(--danger);
        }
    </style>
</head>
<body>
    <!-- Connection Status Indicator -->
    <div class="connection-status" id="connectionStatus">
        <div class="connection-dot online" id="connectionDot"></div>
        <span id="connectionText">Connected</span>
    </div>

    <!-- Install Prompt -->
    <div class="install-prompt" id="installPrompt">
        <button class="install-prompt-close" onclick="hideInstallPrompt()">
            <i class="fas fa-times"></i>
        </button>
        <div class="install-prompt-header">
            <div class="install-prompt-icon">
                <i class="fas fa-chart-line"></i>
            </div>
            <div class="install-prompt-title">Install NeoTrade</div>
        </div>
        <div class="install-prompt-description">
            Install this app on your device for a better trading experience. Works offline and sends notifications.
        </div>
        <div class="install-prompt-actions">
            <button class="btn btn-primary" onclick="installApp()">
                <i class="fas fa-download"></i>
                Install
            </button>
            <button class="btn btn-outline" onclick="hideInstallPrompt()">
                Not Now
            </button>
        </div>
    </div>

    <div class="alert" id="alert">
        <i class="fas fa-bell alert-icon"></i>
        <div class="alert-content">
            <div class="alert-title">Notification</div>
            <div class="alert-message" id="alertMessage">Message here</div>
        </div>
        <button class="alert-close" onclick="closeAlert()">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <header class="header">
        <div class="container header-container">
            <div class="logo">
                <div class="logo-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <span>NeoTrade</span>
            </div>
            
            <div class="header-content">
                <div class="header-nav">
                    <button class="nav-btn active" onclick="switchTab('market')">
                        <i class="fas fa-chart-bar"></i>
                        Market
                    </button>
                    <button class="nav-btn" onclick="switchTab('trading')">
                        <i class="fas fa-trade"></i>
                        Trading
                    </button>
                    <button class="nav-btn" onclick="switchTab('watchlist')">
                        <i class="fas fa-star"></i>
                        Watchlist
                    </button>
                    <button class="nav-btn" onclick="switchTab('history')">
                        <i class="fas fa-history"></i>
                        History
                    </button>
                    <button class="nav-btn" onclick="switchTab('settings')">
                        <i class="fas fa-cog"></i>
                        Settings
                    </button>
                </div>
                
                <div class="search-container">
                    <div class="search-wrapper">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" class="search-input" id="globalSearch" 
                               placeholder="Search all Binance coins (BTC, ETH, etc.)" 
                               onkeyup="searchAllCoins()">
                        <div class="search-results" id="searchResults"></div>
                    </div>
                </div>
                
                <div class="header-stats">
                    <div class="live-indicator">
                        <span class="live-dot"></span>
                        LIVE
                    </div>
                    <div id="lastUpdate">Loading...</div>
                </div>
            </div>
        </div>
    </header>

    <main class="container">
        <div class="dashboard-stats">
            <div class="stat-card total-pnl">
                <div class="stat-header">
                    <div class="stat-title">Total P&L</div>
                    <div class="stat-icon">
                        <i class="fas fa-wallet"></i>
                    </div>
                </div>
                <div class="stat-value" id="totalPnlValue">$0.00</div>
                <div class="stat-change">
                    <span>Today:</span>
                    <span class="stat-change-value positive" id="todayPnlValue">+$0.00</span>
                </div>
            </div>
            
            <div class="stat-card active-trades">
                <div class="stat-header">
                    <div class="stat-title">Active Trades</div>
                    <div class="stat-icon">
                        <i class="fas fa-exchange-alt"></i>
                    </div>
                </div>
                <div class="stat-value" id="activeTradesCount">0</div>
                <div class="stat-change">
                    <span>Total:</span>
                    <span class="stat-change-value" id="totalTradesCount">0</span>
                </div>
            </div>
            
            <div class="stat-card watchlist">
                <div class="stat-header">
                    <div class="stat-title">Watchlist</div>
                    <div class="stat-icon">
                        <i class="fas fa-star"></i>
                    </div>
                </div>
                <div class="stat-value" id="watchlistCount">0</div>
                <div class="stat-change">
                    <span>Updated:</span>
                    <span id="lastUpdateTime">Just now</span>
                </div>
            </div>
            
            <div class="stat-card market-status">
                <div class="stat-header">
                    <div class="stat-title">Market Status</div>
                    <div class="stat-icon">
                        <i class="fas fa-signal"></i>
                    </div>
                </div>
                <div class="stat-value" id="marketStatus">Live</div>
                <div class="stat-change">
                    <span>Refresh:</span>
                    <span id="refreshRateDisplay">3s</span>
                </div>
            </div>
        </div>

        <div class="trading-stats" id="tradingStats">
            <!-- Will be populated dynamically -->
        </div>

        <div class="tabs-container">
            <div class="tabs-header">
                <button class="tab-btn active" onclick="switchTab('market')">
                    <i class="fas fa-chart-bar"></i>
                    Market View
                </button>
                <button class="tab-btn" onclick="switchTab('trading')">
                    <i class="fas fa-trade"></i>
                    Trading Desk
                </button>
                <button class="tab-btn" onclick="switchTab('watchlist')">
                    <i class="fas fa-star"></i>
                    Watchlist
                </button>
                <button class="tab-btn" onclick="switchTab('history')">
                    <i class="fas fa-history"></i>
                    Trade History
                </button>
                <button class="tab-btn" onclick="switchTab('settings')">
                    <i class="fas fa-cog"></i>
                    Settings
                </button>
            </div>

            <div id="marketTab" class="tab-content active">
                <!-- Market view content unchanged -->
                <div class="market-section">
                    <div class="section-header">
                        <div class="section-title">
                            <i class="fas fa-arrow-up"></i>
                            Top Gainers (from Daily Open)
                        </div>
                        <div class="section-controls">
                            <input type="text" class="search-control" id="gainersSearch" 
                                   placeholder="Filter gainers..." onkeyup="filterTable('gainersTable', this.value)">
                        </div>
                    </div>
                    <div class="table-container">
                        <div class="loading" id="gainersLoading">
                            <div class="loading-spinner"></div>
                            <div class="loading-text">Loading gainers...</div>
                        </div>
                        <table class="market-table" id="gainersTable" style="display: none;">
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Price</th>
                                    <th>Change from Open</th>
                                    <th>24h Range</th>
                                    <th>Volume</th>
                                    <th>Rejection</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

                <div class="market-section">
                    <div class="section-header">
                        <div class="section-title">
                            <i class="fas fa-arrow-down"></i>
                            Top Losers (from Daily Open)
                        </div>
                        <div class="section-controls">
                            <input type="text" class="search-control" id="losersSearch" 
                                   placeholder="Filter losers..." onkeyup="filterTable('losersTable', this.value)">
                        </div>
                    </div>
                    <div class="table-container">
                        <div class="loading" id="losersLoading">
                            <div class="loading-spinner"></div>
                            <div class="loading-text">Loading losers...</div>
                        </div>
                        <table class="market-table" id="losersTable" style="display: none;">
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Price</th>
                                    <th>Change from Open</th>
                                    <th>24h Range</th>
                                    <th>Volume</th>
                                    <th>Rejection</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="tradingTab" class="tab-content">
                <div class="trading-container">
                    <div class="trade-form">
                        <div class="form-header">
                            <div class="form-title">Enter New Trade</div>
                            <div id="selectedSymbolDisplay" style="display: none;">
                                <!-- Will show selected symbol -->
                            </div>
                        </div>
                        
                        <!-- Order Type Selector -->
                        <div class="order-type-selector">
                            <button class="order-type-btn active" onclick="setOrderType('market')">
                                <i class="fas fa-bolt"></i>
                                Market Order
                            </button>
                            <button class="order-type-btn" onclick="setOrderType('limit')">
                                <i class="fas fa-clock"></i>
                                Limit Order
                            </button>
                            <button class="order-type-btn" onclick="setOrderType('stop_limit')">
                                <i class="fas fa-flag"></i>
                                Stop Limit
                            </button>
                        </div>
                        
                        <!-- Margin Mode Selector -->
                        <div class="margin-mode-selector">
                            <button class="margin-mode-btn active" onclick="setMarginMode('isolated')">
                                <i class="fas fa-box"></i>
                                Isolated Margin
                            </button>
                            <button class="margin-mode-btn" onclick="setMarginMode('cross')">
                                <i class="fas fa-exchange-alt"></i>
                                Cross Margin
                            </button>
                        </div>
                        
                        <!-- Margin Info -->
                        <div class="margin-info" id="marginInfo">
                            <span class="margin-info-label">Available Margin:</span>
                            <span class="margin-info-value" id="availableMargin">$10,000.00</span>
                        </div>
                        
                        <div id="selectedSymbolInfo" class="selected-symbol" style="display: none;">
                            <div class="coin-icon" id="selectedCoinIcon">BTC</div>
                            <div class="selected-symbol-info">
                                <div class="selected-symbol-name" id="selectedSymbolName">BTCUSDT</div>
                                <div class="selected-symbol-price" id="selectedSymbolPrice">$0.00</div>
                            </div>
                            <div class="selected-symbol-change">
                                <span id="selectedSymbolChange">0.00%</span>
                            </div>
                            <button class="btn btn-outline" onclick="clearSelectedSymbol()" style="padding: 8px 16px;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Trade Side</label>
                                <select class="form-control select" id="tradeSide" onchange="calculateFees()">
                                    <option value="long">Long (Buy)</option>
                                    <option value="short">Short (Sell)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Leverage</label>
                                <div class="slider-container">
                                    <div class="slider-value" id="leverageValue">10x</div>
                                    <input type="range" min="1" max="125" value="10" class="slider" id="tradeLeverage" 
                                           oninput="updateLeverageValue(this.value); calculateFees()">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Limit Order Price (Hidden by default) -->
                        <div class="form-group" id="limitPriceGroup" style="display: none;">
                            <label class="form-label">Limit Price (USDT)</label>
                            <input type="number" class="form-control" id="limitPrice" 
                                   step="0.00000001" placeholder="0.00" oninput="calculateFees()">
                        </div>
                        
                        <!-- Stop Limit Order Fields (Hidden by default) -->
                        <div class="stop-limit-group" id="stopLimitGroup">
                            <div class="stop-limit-header">
                                <i class="fas fa-flag"></i>
                                <div style="font-weight: 600;">Stop Limit Order Settings</div>
                            </div>
                            <div class="stop-limit-info">
                                <i class="fas fa-info-circle"></i>
                                Stop Limit orders trigger a limit order when the stop price is reached.
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Stop Price (USDT)</label>
                                    <input type="number" class="form-control" id="stopPrice" 
                                           step="0.00000001" placeholder="0.00" oninput="updateStopLimitInfo()">
                                    <div style="font-size: 11px; color: var(--light-3); margin-top: 4px;">
                                        Triggers when price reaches this level
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Limit Price (USDT)</label>
                                    <input type="number" class="form-control" id="stopLimitPrice" 
                                           step="0.00000001" placeholder="0.00" oninput="updateStopLimitInfo()">
                                    <div style="font-size: 11px; color: var(--light-3); margin-top: 4px;">
                                        Order executes at this price or better
                                    </div>
                                </div>
                            </div>
                            <div style="background: rgba(245, 158, 11, 0.1); padding: 8px; border-radius: var(--border-radius-sm); margin-top: 12px; font-size: 12px;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                    <span style="color: var(--light-3);">Current Price:</span>
                                    <span id="currentPriceDisplay">$0.00</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                    <span style="color: var(--light-3);">Stop Distance:</span>
                                    <span id="stopDistanceDisplay">0.00%</span>
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <span style="color: var(--light-3);">Status:</span>
                                    <span id="stopLimitStatus" style="color: var(--warning);">Inactive</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label" id="priceLabel">Entry Price (USDT)</label>
                                <input type="number" class="form-control" id="entryPrice" 
                                       step="0.00000001" placeholder="0.00" oninput="calculateFees()">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Position Size (USDT)</label>
                                <input type="number" class="form-control" id="tradeSize" 
                                       value="100" min="1" oninput="calculateFees()">
                            </div>
                        </div>
                        
                        <!-- Margin Allocation (Only for Isolated) -->
                        <div class="form-group" id="marginAllocationGroup">
                            <label class="form-label">Margin Allocation (%)</label>
                            <div class="slider-container">
                                <div class="slider-value" id="marginAllocationValue">10%</div>
                                <input type="range" min="1" max="100" value="10" class="slider" id="marginAllocation" 
                                       oninput="updateMarginAllocationValue(this.value); calculateFees()">
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label class="form-label">Take Profit (%)</label>
                                <input type="number" class="form-control" id="takeProfit" 
                                       value="10" step="0.1" oninput="calculateFees()">
                            </div>
                            <div class="form-group">
                                <label class="form-label">Stop Loss (%)</label>
                                <input type="number" class="form-control" id="stopLoss" 
                                       value="5" step="0.1">
                            </div>
                        </div>
                        
                        <!-- Fee Calculation Display -->
                        <div class="fee-display" id="feeDisplay" style="display: none;">
                            <div class="fee-row">
                                <span class="fee-label">Taker Fee:</span>
                                <span class="fee-value" id="takerFeeValue">0.04%</span>
                            </div>
                            <div class="fee-row">
                                <span class="fee-label">Maker Fee:</span>
                                <span class="fee-value" id="makerFeeValue">0.02%</span>
                            </div>
                            <div class="fee-row">
                                <span class="fee-label">Entry Fee:</span>
                                <span class="fee-value" id="entryFeeValue">$0.00</span>
                            </div>
                            <div class="fee-row">
                                <span class="fee-label">Exit Fee (TP):</span>
                                <span class="fee-value" id="exitFeeValue">$0.00</span>
                            </div>
                            <div class="fee-row">
                                <span class="fee-label">Total Fees:</span>
                                <span class="fee-value" id="totalFeeValue">$0.00</span>
                            </div>
                            <div class="fee-row">
                                <span class="fee-label">Breakeven After Fees:</span>
                                <span class="fee-value" id="breakevenValue">0.00%</span>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Trade Comment (Optional)</label>
                            <textarea class="form-control" id="tradeComment" 
                                      placeholder="Trade rationale, strategy, etc." rows="3"></textarea>
                        </div>
                        
                        <div class="btn-group">
                            <button class="btn btn-success" onclick="enterTrade()" id="enterTradeBtn">
                                <i class="fas fa-play"></i>
                                Enter Trade
                            </button>
                            <button class="btn btn-outline" onclick="resetTradeForm()">
                                <i class="fas fa-redo"></i>
                                Reset Form
                            </button>
                        </div>
                    </div>
                    
                    <div class="active-trades">
                        <div class="section-header">
                            <div class="section-title">
                                <i class="fas fa-list"></i>
                                Active Trades
                            </div>
                            <button class="btn btn-primary" onclick="updateAllTrades()">
                                <i class="fas fa-sync"></i>
                                Refresh All
                            </button>
                        </div>
                        <div class="active-trades-compact" id="activeTradesList">
                            <div class="empty-state">
                                <div class="empty-state-icon">
                                    <i class="fas fa-exchange-alt"></i>
                                </div>
                                <div class="empty-state-title">No Active Trades</div>
                                <div class="empty-state-description">
                                    Open your first trade using the form on the left
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="watchlistTab" class="tab-content">
                <div class="market-section">
                    <div class="section-header">
                        <div class="section-title">
                            <i class="fas fa-star"></i>
                            My Watchlist
                        </div>
                        <div class="section-controls">
                            <button class="btn btn-primary" onclick="addCustomSymbol()">
                                <i class="fas fa-plus"></i>
                                Add Symbol
                            </button>
                            <button class="btn btn-danger" onclick="clearWatchlist()">
                                <i class="fas fa-trash"></i>
                                Clear All
                            </button>
                        </div>
                    </div>
                    <div class="table-container">
                        <div id="watchlistContent">
                            <div class="loading" id="watchlistLoading">
                                <div class="loading-spinner"></div>
                                <div class="loading-text">Loading watchlist...</div>
                            </div>
                            <table class="market-table" id="watchlistTable" style="display: none;">
                                <thead>
                                    <tr>
                                        <th>Symbol</th>
                                        <th>Price</th>
                                        <th>Change</th>
                                        <th>24h Range</th>
                                        <th>Distance from High/Low</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="historyTab" class="tab-content">
                <div class="market-section">
                    <div class="section-header">
                        <div class="section-title">
                            <i class="fas fa-history"></i>
                            Trade History
                        </div>
                        <div class="section-controls">
                            <div class="trade-history-filters">
                                <select class="filter-select" id="historySymbolFilter" onchange="updateTradeHistory()">
                                    <option value="">All Symbols</option>
                                </select>
                                <select class="filter-select" id="historyStatusFilter" onchange="updateTradeHistory()">
                                    <option value="">All Status</option>
                                    <option value="closed_tp">Take Profit</option>
                                    <option value="closed_sl">Stop Loss</option>
                                    <option value="closed_manual">Manual Close</option>
                                    <option value="closed_stop_limit">Stop Limit</option>
                                </select>
                                <select class="filter-select" id="historySideFilter" onchange="updateTradeHistory()">
                                    <option value="">All Sides</option>
                                    <option value="long">Long</option>
                                    <option value="short">Short</option>
                                </select>
                                <input type="date" class="filter-select" id="historyDateFrom" onchange="updateTradeHistory()">
                                <input type="date" class="filter-select" id="historyDateTo" onchange="updateTradeHistory()">
                                <button class="btn btn-outline" onclick="clearHistoryFilters()">
                                    <i class="fas fa-filter"></i>
                                    Clear Filters
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="trade-history-summary" id="tradeHistorySummary">
                        <!-- Will be populated dynamically -->
                    </div>
                    
                    <div class="table-container">
                        <table class="trade-history-table">
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Side</th>
                                    <th>Entry Price</th>
                                    <th>Exit Price</th>
                                    <th>Size</th>
                                    <th>Leverage</th>
                                    <th>P&L</th>
                                    <th>P&L %</th>
                                    <th>Status</th>
                                    <th>Entry Time</th>
                                    <th>Exit Time</th>
                                    <th>Duration</th>
                                </tr>
                            </thead>
                            <tbody id="tradeHistoryBody">
                                <tr>
                                    <td colspan="12" class="empty-state">
                                        <div class="empty-state-icon">
                                            <i class="fas fa-history"></i>
                                        </div>
                                        <div class="empty-state-title">No Trade History</div>
                                        <div class="empty-state-description">
                                            Your closed trades will appear here
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="settingsTab" class="tab-content">
                <div class="settings-grid">
                    <div class="setting-item">
                        <div class="setting-header">
                            <div class="setting-icon">
                                <i class="fas fa-bell"></i>
                            </div>
                            <div class="setting-title">Alert Settings</div>
                        </div>
                        <div class="setting-controls">
                            <div class="setting-row">
                                <span class="setting-label">Sound Alerts</span>
                                <label class="switch">
                                    <input type="checkbox" id="soundAlert" checked>
                                    <span class="slider-switch"></span>
                                </label>
                            </div>
                            <div class="setting-row">
                                <span class="setting-label">Price Alerts</span>
                                <label class="switch">
                                    <input type="checkbox" id="priceAlert" checked>
                                    <span class="slider-switch"></span>
                                </label>
                            </div>
                            <div class="setting-row">
                                <span class="setting-label">TP/SL Alerts</span>
                                <label class="switch">
                                    <input type="checkbox" id="tpslAlert" checked>
                                    <span class="slider-switch"></span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-header">
                            <div class="setting-icon">
                                <i class="fas fa-sync"></i>
                            </div>
                            <div class="setting-title">Refresh Settings</div>
                        </div>
                        <div class="setting-controls">
                            <div class="setting-row">
                                <span class="setting-label">Auto Refresh</span>
                                <label class="switch">
                                    <input type="checkbox" id="autoRefresh" checked>
                                    <span class="slider-switch"></span>
                                </label>
                            </div>
                            <div class="setting-row">
                                <span class="setting-label">Refresh Rate</span>
                                <select class="form-control select" id="refreshRate" style="width: 120px;">
                                    <option value="1000">1 second</option>
                                    <option value="2000">2 seconds</option>
                                    <option value="3000" selected>3 seconds</option>
                                    <option value="5000">5 seconds</option>
                                    <option value="10000">10 seconds</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="setting-item">
                        <div class="setting-header">
                            <div class="setting-icon">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            <div class="setting-title">Trading Settings</div>
                        </div>
                        <div class="setting-controls">
                            <div class="setting-row">
                                <span class="setting-label">Default Leverage</span>
                                <select class="form-control select" id="defaultLeverage" style="width: 120px;">
                                    <option value="1">1x</option>
                                    <option value="5">5x</option>
                                    <option value="10" selected>10x</option>
                                    <option value="20">20x</option>
                                    <option value="50">50x</option>
                                </select>
                            </div>
                            <div class="setting-row">
                                <span class="setting-label">Default TP %</span>
                                <input type="number" class="form-control" id="defaultTP" 
                                       value="10" style="width: 100px;">
                            </div>
                            <div class="setting-row">
                                <span class="setting-label">Default SL %</span>
                                <input type="number" class="form-control" id="defaultSL" 
                                       value="5" style="width: 100px;">
                            </div>
                        </div>
                    </div>

                    <div class="setting-item">
                        <div class="setting-header">
                            <div class="setting-icon">
                                <i class="fas fa-percentage"></i>
                            </div>
                            <div class="setting-title">Margin Settings</div>
                        </div>
                        <div class="setting-controls">
                            <div class="setting-row">
                                <span class="setting-label">Available Margin (USD)</span>
                                <input type="number" class="form-control" id="availableMarginInput" 
                                       value="10000" style="width: 150px;">
                            </div>
                            <div class="setting-row">
                                <span class="setting-label">Default Margin Mode</span>
                                <select class="form-control select" id="defaultMarginMode" style="width: 150px;">
                                    <option value="isolated">Isolated</option>
                                    <option value="cross">Cross</option>
                                </select>
                            </div>
                            <div class="setting-row">
                                <span class="setting-label">Default Margin Allocation %</span>
                                <input type="number" class="form-control" id="defaultMarginAllocation" 
                                       value="10" min="1" max="100" style="width: 100px;">
                            </div>
                        </div>
                    </div>

                    <div class="setting-item">
                        <div class="setting-header">
                            <div class="setting-icon">
                                <i class="fas fa-percentage"></i>
                            </div>
                            <div class="setting-title">Tracking Settings</div>
                        </div>
                        <div class="setting-controls">
                            <div class="setting-row">
                                <span class="setting-label">Long Entry % Below</span>
                                <input type="number" class="form-control" id="longEntryPercent" 
                                       value="1" step="0.1" style="width: 100px;" onchange="updateAllTrackedPrices()">
                            </div>
                            <div class="setting-row">
                                <span class="setting-label">Short Entry % Above</span>
                                <input type="number" class="form-control" id="shortEntryPercent" 
                                       value="1" step="0.1" style="width: 100px;" onchange="updateAllTrackedPrices()">
                            </div>
                        </div>
                    </div>

                    <div class="setting-item">
                        <div class="setting-header">
                            <div class="setting-icon">
                                <i class="fas fa-file-invoice-dollar"></i>
                            </div>
                            <div class="setting-title">Fee Settings</div>
                        </div>
                        <div class="setting-controls">
                            <div class="setting-row">
                                <span class="setting-label">Taker Fee %</span>
                                <input type="number" class="form-control" id="takerFee" 
                                       value="0.04" step="0.001" min="0" max="1" style="width: 100px;">
                            </div>
                            <div class="setting-row">
                                <span class="setting-label">Maker Fee %</span>
                                <input type="number" class="form-control" id="makerFee" 
                                       value="0.02" step="0.001" min="0" max="1" style="width: 100px;">
                            </div>
                            <div class="setting-row">
                                <span class="setting-label">Funding Rate (8h)</span>
                                <input type="number" class="form-control" id="fundingRate" 
                                       value="0.01" step="0.001" min="-1" max="1" style="width: 100px;">
                            </div>
                        </div>
                    </div>

                    <div class="setting-item">
                        <div class="setting-header">
                            <div class="setting-icon">
                                <i class="fas fa-flag"></i>
                            </div>
                            <div class="setting-title">Stop Limit Settings</div>
                        </div>
                        <div class="setting-controls">
                            <div class="setting-row">
                                <span class="setting-label">Default Stop %</span>
                                <input type="number" class="form-control" id="defaultStopPercent" 
                                       value="2" step="0.1" style="width: 100px;">
                            </div>
                            <div class="setting-row">
                                <span class="setting-label">Default Limit Offset %</span>
                                <input type="number" class="form-control" id="defaultLimitOffset" 
                                       value="0.1" step="0.01" style="width: 100px;">
                            </div>
                        </div>
                    </div>
                </div>
                
                <button class="save-settings-btn" onclick="saveSettings()">
                    <i class="fas fa-save"></i>
                    Save All Settings
                </button>
                
                <button class="reset-all-btn" onclick="resetEverything()">
                    <i class="fas fa-bomb"></i>
                    Reset Everything
                </button>
                
                <div style="margin-top: 24px; padding: 16px; background: var(--dark-2); border-radius: var(--border-radius-md);">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-weight: 600; margin-bottom: 4px;">Settings Status</div>
                            <div style="font-size: 14px; color: var(--light-3);" id="settingsStatus">
                                All settings are saved and applied
                            </div>
                        </div>
                        <button class="btn btn-outline" onclick="resetToDefaults()" style="padding: 8px 16px;">
                            <i class="fas fa-undo"></i>
                            Reset Defaults
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Service Worker Registration and PWA Features -->
    <script>
        // Global variables
        let watchlist = new Set();
        let activeTrades = [];
        let pendingOrders = [];
        let currentMarketData = [];
        let allCoinsData = [];
        let refreshInterval;
        let selectedSymbol = null;
        let selectedSymbolData = null;
        let trackedPrices = {};
        let settingsChanged = false;
        let tradeHistory = [];
        let orderType = 'market';
        let marginMode = 'isolated';
        let lastNotificationTime = {};
        let notificationCooldown = 5000;
        let todayPnlData = [];
        let klineCache = {};
        let oiDataCache = {};
        let deferredPrompt = null;
        let isAppInstalled = false;

        // Service Worker Registration
        function registerServiceWorker() {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('Service Worker registered:', registration);
                        
                        // Check for updates every hour
                        setInterval(() => {
                            registration.update();
                        }, 60 * 60 * 1000);
                        
                        // Listen for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    showAlert('New version available. Refresh to update.', 'info');
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.log('ServiceWorker registration failed:', error);
                    });
            }
        }

        // Check if app is installed
        function checkAppInstalled() {
            if (window.matchMedia('(display-mode: standalone)').matches || 
                window.navigator.standalone === true) {
                isAppInstalled = true;
                document.getElementById('installPrompt').style.display = 'none';
            }
        }

        // Handle install prompt
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Show install prompt after 10 seconds
            setTimeout(() => {
                if (!isAppInstalled && deferredPrompt) {
                    showInstallPrompt();
                }
            }, 10000);
        });

        // Show install prompt
        function showInstallPrompt() {
            document.getElementById('installPrompt').style.display = 'block';
        }

        // Hide install prompt
        function hideInstallPrompt() {
            document.getElementById('installPrompt').style.display = 'none';
        }

        // Install app
        async function installApp() {
            if (!deferredPrompt) return;
            
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            
            if (outcome === 'accepted') {
                showAlert('App installed successfully!', 'success');
                isAppInstalled = true;
            }
            
            deferredPrompt = null;
            hideInstallPrompt();
        }

        // Update connection status
        function updateConnectionStatus() {
            const statusElement = document.getElementById('connectionStatus');
            const dotElement = document.getElementById('connectionDot');
            const textElement = document.getElementById('connectionText');
            
            if (navigator.onLine) {
                statusElement.className = 'connection-status online';
                dotElement.className = 'connection-dot online';
                textElement.textContent = 'Connected';
            } else {
                statusElement.className = 'connection-status offline';
                dotElement.className = 'connection-dot offline';
                textElement.textContent = 'Offline';
            }
        }

        // Initialize on DOM load
        document.addEventListener('DOMContentLoaded', function() {
            // Register service worker
            registerServiceWorker();
            
            // Check if app is installed
            checkAppInstalled();
            
            // Update connection status
            updateConnectionStatus();
            window.addEventListener('online', updateConnectionStatus);
            window.addEventListener('offline', updateConnectionStatus);
            
            // Load data and initialize app
            loadFromStorage();
            setupEventListeners();
            initializeDashboard();
            fetchAllCoins();
            refreshInterval = setInterval(fetchMarketData, 3000);
            
            // Start live PNL updates
            setInterval(updateLivePnl, 1000);
            
            // Start pending order monitoring
            setInterval(checkPendingOrders, 1000);
            
            // Start fetching kline data for rejection detection
            setInterval(fetchKlineDataForRejection, 10000);
            
            // Add change listeners to settings
            setupSettingsChangeListeners();
            
            // Initialize trade history
            updateTradeHistory();
            
            // Update today's P&L from storage
            loadTodayPnl();
            
            // Initialize push notifications on user interaction
            initializePushNotifications();
            
            // Show welcome message
            setTimeout(() => {
                showAlert('Welcome to NeoTrade! All systems are operational.', 'success');
            }, 1000);
        });

        // Initialize push notifications
        async function initializePushNotifications() {
            // Request notification permission on user interaction
            const requestPermission = () => {
                if ('Notification' in window && Notification.permission === 'default') {
                    Notification.requestPermission().then(permission => {
                        if (permission === 'granted') {
                            console.log('Notification permission granted');
                        }
                    });
                }
                
                // Remove event listeners
                document.removeEventListener('click', requestPermission);
                document.removeEventListener('keydown', requestPermission);
            };
            
            document.addEventListener('click', requestPermission);
            document.addEventListener('keydown', requestPermission);
        }

        // Send trade notification
        async function sendTradeNotification(trade, type = 'trade') {
            if (!('Notification' in window) || Notification.permission !== 'granted') {
                return;
            }
            
            const title = type === 'tp' ? `ðŸŽ¯ Take Profit Hit: ${trade.symbol}` :
                       type === 'sl' ? `âš ï¸ Stop Loss Hit: ${trade.symbol}` :
                       `ðŸ“ˆ Trade ${trade.status === 'active' ? 'Opened' : 'Closed'}: ${trade.symbol}`;
            
            const body = type === 'tp' ? `Profit: $${trade.pnl.toFixed(2)} (${trade.pnlPercent.toFixed(2)}%)` :
                       type === 'sl' ? `Loss: $${trade.pnl.toFixed(2)} (${trade.pnlPercent.toFixed(2)}%)` :
                       `${trade.side.toUpperCase()} ${trade.leverage}x | P&L: $${trade.pnl.toFixed(2)}`;
            
            const icon = type === 'tp' ? '/icons/success.png' :
                       type === 'sl' ? '/icons/warning.png' :
                       '/icons/trade.png';
            
            const notification = new Notification(title, {
                body: body,
                icon: icon,
                badge: '/icons/badge-72.png',
                tag: `trade-${trade.id}`,
                requireInteraction: true,
                actions: [
                    {
                        action: 'view',
                        title: 'View Trade'
                    }
                ]
            });
            
            notification.onclick = () => {
                window.focus();
                notification.close();
                
                // Switch to trading tab and highlight the trade
                switchTab('trading');
                const tradeRow = document.querySelector(`[data-trade-id="${trade.id}"]`);
                if (tradeRow) {
                    tradeRow.scrollIntoView({ behavior: 'smooth' });
                    tradeRow.style.animation = 'pnlFlash 2s ease';
                    setTimeout(() => {
                        tradeRow.style.animation = '';
                    }, 2000);
                }
            };
            
            return notification;
        }

        // Send price alert notification
        async function sendPriceAlertNotification(symbol, currentPrice, targetPrice, type) {
            if (!('Notification' in window) || Notification.permission !== 'granted') {
                return;
            }
            
            const title = `ðŸ’° Price Alert: ${symbol}`;
            const body = `Price reached ${type} target: $${currentPrice.toFixed(2)}`;
            
            const notification = new Notification(title, {
                body: body,
                icon: '/icons/alert.png',
                badge: '/icons/badge-72.png',
                tag: `price-alert-${symbol}-${Date.now()}`,
                requireInteraction: false
            });
            
            return notification;
        }

        // Enhanced showAlert function with notifications
        function showAlert(message, type = 'info') {
            // Original alert functionality
            const alert = document.getElementById('alert');
            const alertMessage = document.getElementById('alertMessage');
            
            alertMessage.textContent = message;
            alert.className = `alert ${type}`;
            alert.style.display = 'flex';
            
            // Check if sound alerts are enabled
            const soundAlertEnabled = document.getElementById('soundAlert').checked;
            if (soundAlertEnabled && type !== 'info') {
                playAlertSound();
            }
            
            setTimeout(() => {
                if (alert.style.display !== 'none') {
                    alert.style.display = 'none';
                }
            }, 5000);
            
            // Send push notification for important alerts
            if ((type === 'success' || type === 'warning' || type === 'danger') && 
                Notification.permission === 'granted') {
                
                const notificationType = type === 'success' ? 'success' : 
                                      type === 'warning' ? 'warning' : 'error';
                
                const notification = new Notification('NeoTrade Alert', {
                    body: message,
                    icon: `/icons/${notificationType}.png`,
                    badge: '/icons/badge-72.png',
                    tag: `alert-${Date.now()}`,
                    requireInteraction: false
                });
            }
        }

        // Enhanced trade execution with notifications
        const originalExecutePendingOrder = window.executePendingOrder;
        window.executePendingOrder = function(order, index, fillPrice) {
            // Call original function
            originalExecutePendingOrder.call(this, order, index, fillPrice);
            
            // Send notification
            if (Notification.permission === 'granted') {
                sendTradeNotification(order, 'trade');
            }
        };

        // Enhanced closeTrade function with notifications
        const originalCloseTrade = window.closeTrade;
        window.closeTrade = function(tradeId) {
            const trade = activeTrades.find(t => t.id === tradeId);
            if (trade) {
                // Call original function
                originalCloseTrade.call(this, tradeId);
                
                // Send notification
                if (Notification.permission === 'granted') {
                    const type = trade.status === 'closed_tp' ? 'tp' : 
                                trade.status === 'closed_sl' ? 'sl' : 'trade';
                    sendTradeNotification(trade, type);
                }
            }
        };

        // Enhanced enterTrade function with notifications
        const originalEnterTrade = window.enterTrade;
        window.enterTrade = function() {
            // Call original function
            originalEnterTrade.call(this);
            
            // Start high-frequency updates if not already started
            if (activeTrades.length > 0 && !window.highFrequencyInterval) {
                startHighFrequencyUpdates();
            }
            
            // Send notification for market orders
            if (orderType === 'market' && selectedSymbol && Notification.permission === 'granted') {
                const trade = activeTrades[activeTrades.length - 1];
                if (trade) {
                    sendTradeNotification(trade, 'trade');
                }
            }
        };

        // Start high-frequency updates for selected symbol
        function startHighFrequencyUpdates() {
            if (window.highFrequencyInterval) return;
            
            window.highFrequencyInterval = setInterval(async () => {
                if (selectedSymbol) {
                    try {
                        const response = await fetch(`https://fapi.binance.com/fapi/v1/ticker/price?symbol=${selectedSymbol}`);
                        const data = await response.json();
                        
                        if (selectedSymbolData) {
                            selectedSymbolData.lastPrice = data.price;
                            updateSelectedSymbolInfo();
                            updateLivePnl();
                            
                            // Update trade form price
                            if (document.getElementById('entryPrice')) {
                                document.getElementById('entryPrice').value = parseFloat(data.price);
                            }
                        }
                    } catch (error) {
                        // Silently fail for high-frequency updates
                    }
                }
                
                // Update all active trades
                updateLivePnl();
            }, 1000); // Update every second
        }

        // Stop high-frequency updates
        function stopHighFrequencyUpdates() {
            if (window.highFrequencyInterval) {
                clearInterval(window.highFrequencyInterval);
                window.highFrequencyInterval = null;
            }
        }

        // Update all existing functions with high-frequency support
        const originalSelectSymbolForTrading = window.selectSymbolForTrading;
        window.selectSymbolForTrading = function(symbol, coinData = null) {
            originalSelectSymbolForTrading.call(this, symbol, coinData);
            
            // Start high-frequency updates for selected symbol
            if (!window.highFrequencyInterval) {
                startHighFrequencyUpdates();
            }
        };

        const originalClearSelectedSymbol = window.clearSelectedSymbol;
        window.clearSelectedSymbol = function() {
            originalClearSelectedSymbol.call(this);
            
            // Stop high-frequency updates if no trades
            if (activeTrades.length === 0) {
                stopHighFrequencyUpdates();
            }
        };

        // Check for price alerts in tracked prices
        function checkTrackedPriceAlerts() {
            Object.keys(trackedPrices).forEach(symbol => {
                const trackedInfo = trackedPrices[symbol];
                const coinData = currentMarketData.find(item => item.symbol === symbol);
                
                if (coinData) {
                    const currentPrice = parseFloat(coinData.lastPrice);
                    const trackedPrice = trackedInfo.trackedPrice;
                    const longEntryPrice = trackedInfo.longEntryPrice;
                    const shortEntryPrice = trackedInfo.shortEntryPrice;
                    
                    // Check if price reached long entry
                    if (currentPrice <= longEntryPrice * 1.001) {
                        const now = Date.now();
                        const lastNotification = lastNotificationTime[`${symbol}-long-entry`] || 0;
                        
                        if (now - lastNotification > notificationCooldown) {
                            sendPriceAlertNotification(
                                symbol, 
                                currentPrice, 
                                longEntryPrice, 
                                'Long Entry'
                            );
                            lastNotificationTime[`${symbol}-long-entry`] = now;
                        }
                    }
                    
                    // Check if price reached short entry
                    if (currentPrice >= shortEntryPrice * 0.999) {
                        const now = Date.now();
                        const lastNotification = lastNotificationTime[`${symbol}-short-entry`] || 0;
                        
                        if (now - lastNotification > notificationCooldown) {
                            sendPriceAlertNotification(
                                symbol, 
                                currentPrice, 
                                shortEntryPrice, 
                                'Short Entry'
                            );
                            lastNotificationTime[`${symbol}-short-entry`] = now;
                        }
                    }
                }
            });
        }

        // Enhanced fetchMarketData with alert checking
        const originalFetchMarketData = window.fetchMarketData;
        window.fetchMarketData = async function() {
            try {
                await originalFetchMarketData.call(this);
                
                // Check for price alerts
                checkTrackedPriceAlerts();
                
                // Check for pending orders
                checkPendingOrders();
                
            } catch (error) {
                console.error('Error in enhanced fetchMarketData:', error);
            }
        };

        // Enhanced offline handling
        window.addEventListener('online', () => {
            showAlert('Connection restored. Syncing data...', 'success');
            fetchMarketData();
            updateAllTrades();
            updateConnectionStatus();
        });

        window.addEventListener('offline', () => {
            showAlert('You are offline. Some features may be limited.', 'warning');
            updateConnectionStatus();
            
            // Switch to offline mode
            document.getElementById('marketStatus').textContent = 'Offline';
            document.getElementById('marketStatus').style.color = 'var(--warning)';
        });

        // Check connectivity periodically
        setInterval(() => {
            if (!navigator.onLine) {
                document.getElementById('marketStatus').textContent = 'Offline';
                document.getElementById('marketStatus').style.color = 'var(--warning)';
            } else {
                document.getElementById('marketStatus').textContent = 'Live';
                document.getElementById('marketStatus').style.color = 'var(--success)';
            }
        }, 5000);

        // Wake Lock API support for active trading
        let wakeLock = null;
        
        async function requestWakeLock() {
            if ('wakeLock' in navigator) {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('Wake Lock active');
                    
                    wakeLock.addEventListener('release', () => {
                        console.log('Wake Lock released');
                    });
                } catch (err) {
                    console.log('Wake Lock error:', err.name, err.message);
                }
            }
        }
        
        function releaseWakeLock() {
            if (wakeLock !== null) {
                wakeLock.release();
                wakeLock = null;
            }
        }
        
        // Request wake lock when there are active trades
        if (activeTrades.length > 0) {
            requestWakeLock();
        }
        
        // Release wake lock when all trades are closed
        const originalCloseTradeFunction = closeTrade;
        window.closeTrade = function(tradeId) {
            originalCloseTradeFunction.call(this, tradeId);
            
            if (activeTrades.filter(t => !t.closed).length === 0) {
                releaseWakeLock();
            }
        };

        // Initialize dashboard
        async function initializeDashboard() {
            await fetchMarketData();
            updateTradingStats();
            updateDashboard();
        }

        // Load from localStorage with cross-device support
        function loadFromStorage() {
            const savedWatchlist = localStorage.getItem('binanceWatchlist');
            if (savedWatchlist) {
                watchlist = new Set(JSON.parse(savedWatchlist));
            }
            
            const savedTrades = localStorage.getItem('activeTrades');
            if (savedTrades) {
                try {
                    const trades = JSON.parse(savedTrades);
                    // Filter out trades that are closed and older than 7 days
                    const oneWeekAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
                    activeTrades = trades.filter(t => {
                        if (t.closed) {
                            const exitTime = new Date(t.exitTime || t.entryTime).getTime();
                            return exitTime > oneWeekAgo;
                        }
                        return true;
                    });
                    
                    updateTradesDisplay();
                    
                    // Load closed trades into history
                    tradeHistory = activeTrades.filter(t => t.closed);
                } catch(e) {
                    console.error('Error loading trades:', e);
                    activeTrades = [];
                    tradeHistory = [];
                }
            }
            
            // Load pending orders
            const savedPendingOrders = localStorage.getItem('pendingOrders');
            if (savedPendingOrders) {
                try {
                    pendingOrders = JSON.parse(savedPendingOrders);
                } catch(e) {
                    console.error('Error loading pending orders:', e);
                    pendingOrders = [];
                }
            }
            
            const savedSettings = localStorage.getItem('tradingSettings');
            if (savedSettings) {
                try {
                    const settings = JSON.parse(savedSettings);
                    applySettings(settings);
                    updateSettingsStatus('All settings loaded from storage', 'success');
                } catch(e) {
                    console.error('Error loading settings:', e);
                    resetToDefaults();
                    updateSettingsStatus('Error loading settings, using defaults', 'warning');
                }
            } else {
                resetToDefaults();
                updateSettingsStatus('Using default settings', 'info');
            }
            
            const savedTrackedPrices = localStorage.getItem('trackedPrices');
            if (savedTrackedPrices) {
                try {
                    trackedPrices = JSON.parse(savedTrackedPrices);
                } catch(e) {
                    console.error('Error loading tracked prices:', e);
                    trackedPrices = {};
                }
            }
            
            // Update UI based on loaded settings
            updateLeverageValue(document.getElementById('defaultLeverage').value || 10);
            updateMarginAllocationValue(document.getElementById('defaultMarginAllocation').value || 10);
            
            // Update available margin display
            updateAvailableMargin();
        }

        // Load today's P&L from storage
        function loadTodayPnl() {
            const savedTodayPnl = localStorage.getItem('todayPnl');
            if (savedTodayPnl) {
                try {
                    todayPnlData = JSON.parse(savedTodayPnl);
                } catch(e) {
                    console.error('Error loading today P&L:', e);
                    todayPnlData = [];
                }
            }
            updateTodayPnlDisplay();
        }

        // Save today's P&L to storage
        function saveTodayPnl() {
            localStorage.setItem('todayPnl', JSON.stringify(todayPnlData));
        }

        // Update today's P&L display
        function updateTodayPnlDisplay() {
            const today = new Date().toDateString();
            const todayClosedTrades = tradeHistory.filter(t => {
                const tradeDate = new Date(t.exitTime || t.entryTime).toDateString();
                return tradeDate === today;
            });
            
            // Sum P&L from closed trades today
            let todayClosedPnl = todayClosedTrades.reduce((sum, trade) => sum + (trade.pnlAfterFees || trade.pnl || 0), 0);
            
            // Sum P&L from today's recorded P&L data
            let todayRecordedPnl = todayPnlData.reduce((sum, item) => sum + item.pnl, 0);
            
            // Total today's P&L
            let totalTodayPnl = todayClosedPnl + todayRecordedPnl;
            
            // Also add P&L from active trades that were opened today
            const todayActiveTrades = activeTrades.filter(t => {
                const tradeDate = new Date(t.entryTime).toDateString();
                return tradeDate === today && !t.closed && t.status === 'active';
            });
            
            let todayActivePnl = todayActiveTrades.reduce((sum, trade) => sum + (trade.pnl || 0), 0);
            
            // Update display
            const todayPnlElement = document.getElementById('todayPnlValue');
            const totalToday = totalTodayPnl + todayActivePnl;
            
            todayPnlElement.textContent = (totalToday >= 0 ? '+$' : '-$') + Math.abs(totalToday).toFixed(2);
            todayPnlElement.className = `stat-change-value ${totalToday >= 0 ? 'positive' : 'negative'}`;
        }

        // Record today's P&L when a trade is closed
        function recordTodayPnl(trade) {
            const today = new Date().toDateString();
            const tradeDate = new Date(trade.exitTime || trade.entryTime).toDateString();
            
            if (tradeDate === today) {
                todayPnlData.push({
                    id: trade.id,
                    symbol: trade.symbol,
                    pnl: trade.pnlAfterFees || trade.pnl || 0,
                    time: new Date().toISOString()
                });
                saveTodayPnl();
                updateTodayPnlDisplay();
            }
        }

        // Apply settings to UI
        function applySettings(settings) {
            document.getElementById('defaultLeverage').value = settings.defaultLeverage || 10;
            document.getElementById('defaultTP').value = settings.defaultTP || 10;
            document.getElementById('defaultSL').value = settings.defaultSL || 5;
            document.getElementById('refreshRate').value = settings.refreshRate || 3000;
            document.getElementById('autoRefresh').checked = settings.autoRefresh !== false;
            document.getElementById('longEntryPercent').value = settings.longEntryPercent || 1;
            document.getElementById('shortEntryPercent').value = settings.shortEntryPercent || 1;
            document.getElementById('takerFee').value = settings.takerFee || 0.04;
            document.getElementById('makerFee').value = settings.makerFee || 0.02;
            document.getElementById('fundingRate').value = settings.fundingRate || 0.01;
            document.getElementById('soundAlert').checked = settings.soundAlert !== false;
            document.getElementById('priceAlert').checked = settings.priceAlert !== false;
            document.getElementById('tpslAlert').checked = settings.tpslAlert !== false;
            document.getElementById('availableMarginInput').value = settings.availableMargin || 10000;
            document.getElementById('defaultMarginMode').value = settings.defaultMarginMode || 'isolated';
            document.getElementById('defaultMarginAllocation').value = settings.defaultMarginAllocation || 10;
            document.getElementById('defaultStopPercent').value = settings.defaultStopPercent || 2;
            document.getElementById('defaultLimitOffset').value = settings.defaultLimitOffset || 0.1;
            
            // Set initial margin mode
            setMarginMode(settings.defaultMarginMode || 'isolated');
            
            // Update refresh rate display
            document.getElementById('refreshRateDisplay').textContent = (settings.refreshRate || 3000) / 1000 + 's';
            
            // Update available margin display
            updateAvailableMargin();
        }

        // Update available margin display
        function updateAvailableMargin() {
            const availableMargin = parseFloat(document.getElementById('availableMarginInput').value) || 10000;
            document.getElementById('availableMargin').textContent = '$' + availableMargin.toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        // Set order type
        function setOrderType(type) {
            orderType = type;
            
            // Update UI
            document.querySelectorAll('.order-type-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[onclick="setOrderType('${type}')"]`).classList.add('active');
            
            // Show/hide appropriate fields
            const limitPriceGroup = document.getElementById('limitPriceGroup');
            const stopLimitGroup = document.getElementById('stopLimitGroup');
            const priceLabel = document.getElementById('priceLabel');
            const entryPriceInput = document.getElementById('entryPrice');
            const enterTradeBtn = document.getElementById('enterTradeBtn');
            
            if (type === 'limit') {
                limitPriceGroup.style.display = 'block';
                stopLimitGroup.classList.remove('active');
                priceLabel.textContent = 'Limit Price (USDT)';
                enterTradeBtn.innerHTML = '<i class="fas fa-clock"></i> Place Limit Order';
                
                // Set limit price to current price if empty
                if (!entryPriceInput.value && selectedSymbolData) {
                    entryPriceInput.value = parseFloat(selectedSymbolData.lastPrice);
                }
            } else if (type === 'stop_limit') {
                limitPriceGroup.style.display = 'none';
                stopLimitGroup.classList.add('active');
                priceLabel.textContent = 'Limit Price (USDT) - Auto-filled';
                enterTradeBtn.innerHTML = '<i class="fas fa-flag"></i> Place Stop Limit Order';
                
                // Auto-fill stop and limit prices
                updateStopLimitPrices();
            } else {
                limitPriceGroup.style.display = 'none';
                stopLimitGroup.classList.remove('active');
                priceLabel.textContent = 'Entry Price (USDT)';
                enterTradeBtn.innerHTML = '<i class="fas fa-bolt"></i> Enter Trade';
                
                // Set market price if empty
                if (!entryPriceInput.value && selectedSymbolData) {
                    entryPriceInput.value = parseFloat(selectedSymbolData.lastPrice);
                }
            }
            
            // Recalculate fees
            calculateFees();
        }

        // Update stop limit prices based on current price and settings
        function updateStopLimitPrices() {
            if (!selectedSymbolData) return;
            
            const currentPrice = parseFloat(selectedSymbolData.lastPrice);
            const stopPercent = parseFloat(document.getElementById('defaultStopPercent').value) || 2;
            const limitOffset = parseFloat(document.getElementById('defaultLimitOffset').value) || 0.1;
            const side = document.getElementById('tradeSide').value;
            
            let stopPrice, limitPrice;
            
            if (side === 'long') {
                // For long: stop above current price (price rises to stop), limit slightly above stop
                stopPrice = currentPrice * (1 + stopPercent / 100);
                limitPrice = stopPrice * (1 + limitOffset / 100);
            } else {
                // For short: stop below current price (price drops to stop), limit slightly below stop
                stopPrice = currentPrice * (1 - stopPercent / 100);
                limitPrice = stopPrice * (1 - limitOffset / 100);
            }
            
            document.getElementById('stopPrice').value = stopPrice.toFixed(8);
            document.getElementById('stopLimitPrice').value = limitPrice.toFixed(8);
            document.getElementById('entryPrice').value = limitPrice.toFixed(8);
            
            updateStopLimitInfo();
        }

        // Update stop limit info display
        function updateStopLimitInfo() {
            if (!selectedSymbolData) return;
            
            const currentPrice = parseFloat(selectedSymbolData.lastPrice);
            const stopPrice = parseFloat(document.getElementById('stopPrice').value) || 0;
            const limitPrice = parseFloat(document.getElementById('stopLimitPrice').value) || 0;
            const side = document.getElementById('tradeSide').value;
            
            document.getElementById('currentPriceDisplay').textContent = 
                '$' + currentPrice.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 8});
            
            if (stopPrice > 0) {
                const stopDistance = ((stopPrice - currentPrice) / currentPrice) * 100;
                document.getElementById('stopDistanceDisplay').textContent = stopDistance.toFixed(2) + '%';
                document.getElementById('stopDistanceDisplay').className = stopDistance >= 0 ? 'positive' : 'negative';
                
                // Update status
                if ((side === 'long' && currentPrice >= stopPrice) || 
                    (side === 'short' && currentPrice <= stopPrice)) {
                    document.getElementById('stopLimitStatus').textContent = 'Triggered';
                    document.getElementById('stopLimitStatus').style.color = 'var(--success)';
                } else {
                    document.getElementById('stopLimitStatus').textContent = 'Waiting';
                    document.getElementById('stopLimitStatus').style.color = 'var(--warning)';
                }
            }
        }

        // Set margin mode
        function setMarginMode(mode) {
            marginMode = mode;
            
            // Update UI
            document.querySelectorAll('.margin-mode-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[onclick="setMarginMode('${mode}')"]`).classList.add('active');
            
            // Show/hide margin allocation for isolated mode
            const marginAllocationGroup = document.getElementById('marginAllocationGroup');
            if (mode === 'isolated') {
                marginAllocationGroup.style.display = 'block';
            } else {
                marginAllocationGroup.style.display = 'none';
            }
            
            // Update available margin display
            updateAvailableMargin();
        }

        // Update margin allocation value display
        function updateMarginAllocationValue(value) {
            document.getElementById('marginAllocationValue').textContent = value + '%';
            document.getElementById('marginAllocation').value = value;
        }

        // Save to localStorage (cross-device support)
        function saveToStorage() {
            localStorage.setItem('binanceWatchlist', JSON.stringify([...watchlist]));
            localStorage.setItem('activeTrades', JSON.stringify(activeTrades));
            localStorage.setItem('pendingOrders', JSON.stringify(pendingOrders));
            localStorage.setItem('trackedPrices', JSON.stringify(trackedPrices));
            localStorage.setItem('tradeHistory', JSON.stringify(tradeHistory));
        }

        // Save settings to localStorage (cross-device support)
        function saveSettings() {
            const settings = {
                defaultLeverage: parseInt(document.getElementById('defaultLeverage').value),
                defaultTP: parseFloat(document.getElementById('defaultTP').value),
                defaultSL: parseFloat(document.getElementById('defaultSL').value),
                refreshRate: parseInt(document.getElementById('refreshRate').value),
                autoRefresh: document.getElementById('autoRefresh').checked,
                longEntryPercent: parseFloat(document.getElementById('longEntryPercent').value),
                shortEntryPercent: parseFloat(document.getElementById('shortEntryPercent').value),
                takerFee: parseFloat(document.getElementById('takerFee').value),
                makerFee: parseFloat(document.getElementById('makerFee').value),
                fundingRate: parseFloat(document.getElementById('fundingRate').value),
                soundAlert: document.getElementById('soundAlert').checked,
                priceAlert: document.getElementById('priceAlert').checked,
                tpslAlert: document.getElementById('tpslAlert').checked,
                availableMargin: parseFloat(document.getElementById('availableMarginInput').value),
                defaultMarginMode: document.getElementById('defaultMarginMode').value,
                defaultMarginAllocation: parseFloat(document.getElementById('defaultMarginAllocation').value),
                defaultStopPercent: parseFloat(document.getElementById('defaultStopPercent').value),
                defaultLimitOffset: parseFloat(document.getElementById('defaultLimitOffset').value),
                lastSaved: new Date().toISOString()
            };
            
            localStorage.setItem('tradingSettings', JSON.stringify(settings));
            
            // Update refresh interval if auto-refresh is enabled
            clearInterval(refreshInterval);
            if (settings.autoRefresh) {
                refreshInterval = setInterval(fetchMarketData, settings.refreshRate);
            }
            
            // Update display
            document.getElementById('refreshRateDisplay').textContent = (settings.refreshRate / 1000) + 's';
            
            // Update available margin
            updateAvailableMargin();
            
            // Update watchlist display to reflect new settings
            updateAllTrackedPrices();
            
            // Reset changed flag
            settingsChanged = false;
            updateSettingsStatus('All settings saved successfully!', 'success');
            showAlert('Settings saved successfully', 'success');
            
            console.log('Settings saved:', settings);
        }

        // Reset everything - FIXED to properly clear all data
        function resetEverything() {
            if (confirm('âš ï¸ WARNING: This will delete ALL data including trades, watchlist, settings, and history. This action cannot be undone. Are you sure?')) {
                // Clear all localStorage items related to the app
                const itemsToRemove = [
                    'binanceWatchlist',
                    'activeTrades',
                    'trackedPrices',
                    'pendingOrders',
                    'tradeHistory',
                    'tradingSettings',
                    'todayPnl'
                ];
                
                itemsToRemove.forEach(item => {
                    localStorage.removeItem(item);
                });
                
                // Reset all variables
                watchlist = new Set();
                activeTrades = [];
                tradeHistory = [];
                trackedPrices = {};
                todayPnlData = [];
                pendingOrders = [];
                klineCache = {};
                oiDataCache = {};
                
                // Reset settings to defaults
                resetToDefaults();
                
                // Reset UI
                updateTradesDisplay();
                updateWatchlistDisplay();
                updateTradeHistory();
                updateDashboard();
                updateTradingStats();
                
                // Clear selected symbol
                clearSelectedSymbol();
                
                // Reset trade form
                resetTradeForm();
                
                // Clear search
                document.getElementById('globalSearch').value = '';
                document.getElementById('searchResults').style.display = 'none';
                
                // Show success message
                showAlert('All data has been reset to defaults', 'success');
                updateSettingsStatus('All data reset to defaults', 'info');
                
                console.log('All data reset');
            }
        }

        // Update all tracked prices when settings change
        function updateAllTrackedPrices() {
            const longEntryPercent = parseFloat(document.getElementById('longEntryPercent').value) || 1;
            const shortEntryPercent = parseFloat(document.getElementById('shortEntryPercent').value) || 1;
            
            // Update all tracked prices with new percentages
            Object.keys(trackedPrices).forEach(symbol => {
                const trackedInfo = trackedPrices[symbol];
                const trackedPrice = trackedInfo.trackedPrice;
                
                // Recalculate entry prices based on new percentages
                trackedInfo.longEntryPercent = longEntryPercent;
                trackedInfo.shortEntryPercent = shortEntryPercent;
                
                // Recalculate entry prices
                trackedInfo.longEntryPrice = trackedPrice * (1 - longEntryPercent / 100);
                trackedInfo.shortEntryPrice = trackedPrice * (1 + shortEntryPercent / 100);
            });
            
            saveToStorage();
            
            // Update display
            updateWatchlistDisplay();
            updateMarketTables();
            
            showAlert(`Updated tracking prices: Long entry ${longEntryPercent}% below, Short entry ${shortEntryPercent}% above tracked price`, 'info');
        }

        // Setup settings change listeners
        function setupSettingsChangeListeners() {
            const settingsInputs = [
                'defaultLeverage', 'defaultTP', 'defaultSL', 'refreshRate',
                'longEntryPercent', 'shortEntryPercent', 'takerFee', 'makerFee', 'fundingRate',
                'availableMarginInput', 'defaultMarginMode', 'defaultMarginAllocation',
                'defaultStopPercent', 'defaultLimitOffset'
            ];
            
            settingsInputs.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', function() {
                        settingsChanged = true;
                        updateSettingsStatus('Settings have been modified. Click Save to apply.', 'warning');
                        
                        // Update available margin if changed
                        if (id === 'availableMarginInput') {
                            updateAvailableMargin();
                        }
                        
                        // Update stop limit prices if relevant setting changed
                        if (id === 'defaultStopPercent' || id === 'defaultLimitOffset') {
                            if (orderType === 'stop_limit') {
                                updateStopLimitPrices();
                            }
                        }
                    });
                }
            });
            
            // For checkboxes
            const checkboxes = ['autoRefresh', 'soundAlert', 'priceAlert', 'tpslAlert'];
            checkboxes.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', function() {
                        settingsChanged = true;
                        updateSettingsStatus('Settings have been modified. Click Save to apply.', 'warning');
                    });
                }
            });
        }

        // Update settings status display
        function updateSettingsStatus(message, type = 'info') {
            const statusElement = document.getElementById('settingsStatus');
            statusElement.textContent = message;
            
            switch(type) {
                case 'success':
                    statusElement.style.color = 'var(--success)';
                    break;
                case 'warning':
                    statusElement.style.color = 'var(--warning)';
                    break;
                case 'danger':
                    statusElement.style.color = 'var(--danger)';
                    break;
                default:
                    statusElement.style.color = 'var(--light-3)';
            }
        }

        // Reset to default settings
        function resetToDefaults() {
            if (confirm('Reset all settings to default values? This will discard any unsaved changes.')) {
                const defaults = {
                    defaultLeverage: 10,
                    defaultTP: 10,
                    defaultSL: 5,
                    refreshRate: 3000,
                    autoRefresh: true,
                    longEntryPercent: 1,
                    shortEntryPercent: 1,
                    takerFee: 0.04,
                    makerFee: 0.02,
                    fundingRate: 0.01,
                    soundAlert: true,
                    priceAlert: true,
                    tpslAlert: true,
                    availableMargin: 10000,
                    defaultMarginMode: 'isolated',
                    defaultMarginAllocation: 10,
                    defaultStopPercent: 2,
                    defaultLimitOffset: 0.1
                };
                
                applySettings(defaults);
                settingsChanged = false;
                updateSettingsStatus('Reset to default settings', 'info');
                showAlert('Settings reset to defaults', 'info');
            }
        }

        // Fetch all Binance coins
        async function fetchAllCoins() {
            try {
                const response = await fetch('https://api.binance.com/api/v3/exchangeInfo');
                const data = await response.json();
                allCoinsData = data.symbols
                    .filter(symbol => symbol.status === 'TRADING' && symbol.quoteAsset === 'USDT')
                    .map(symbol => ({
                        symbol: symbol.symbol,
                        baseAsset: symbol.baseAsset,
                        quoteAsset: symbol.quoteAsset
                    }));
                
                console.log(`Loaded ${allCoinsData.length} trading pairs`);
                
                // Update history symbol filter
                updateHistoryFilters();
            } catch (error) {
                console.error('Error fetching all coins:', error);
                showAlert('Failed to load coin list', 'danger');
            }
        }

        // Fetch market data
        async function fetchMarketData() {
            try {
                const response = await fetch('https://fapi.binance.com/fapi/v1/ticker/24hr');
                const data = await response.json();
                
                currentMarketData = data.filter(item => item.symbol.endsWith('USDT'));
                
                // Update tables with rejection indicators
                updateMarketTables();
                updateWatchlistDisplay();
                updateSelectedSymbolInfo();
                updateTrackedPricesDisplay();
                updateStopLimitInfo();
                
                const now = new Date();
                document.getElementById('lastUpdate').textContent = now.toLocaleTimeString();
                document.getElementById('lastUpdateTime').textContent = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                document.querySelectorAll('.loading').forEach(el => el.style.display = 'none');
                document.querySelectorAll('.market-table').forEach(el => el.style.display = 'table');
                
            } catch (error) {
                console.error('Error fetching market data:', error);
                document.getElementById('marketStatus').textContent = 'Error';
                showAlert('Failed to fetch market data', 'danger');
            }
        }

        // Fetch kline data for rejection detection
        async function fetchKlineDataForRejection() {
            if (!currentMarketData.length) return;
            
            // Fetch for top 20 gainers and losers
            const topSymbols = [...currentMarketData]
                .sort((a, b) => {
                    const aChange = ((parseFloat(a.lastPrice) - parseFloat(a.openPrice)) / parseFloat(a.openPrice)) * 100;
                    const bChange = ((parseFloat(b.lastPrice) - parseFloat(b.openPrice)) / parseFloat(b.openPrice)) * 100;
                    return Math.abs(bChange) - Math.abs(aChange);
                })
                .slice(0, 40)
                .map(item => item.symbol);
            
            for (const symbol of topSymbols) {
                try {
                    const response = await fetch(`https://fapi.binance.com/fapi/v1/klines?symbol=${symbol}&interval=5m&limit=10`);
                    const klines = await response.json();
                    klineCache[symbol] = klines;
                } catch (error) {
                    console.error(`Error fetching kline data for ${symbol}:`, error);
                }
            }
        }

        // Check for rejection patterns
        function checkRejectionPattern(symbol) {
            const klines = klineCache[symbol];
            if (!klines || klines.length < 5) return null;
            
            const recentCandles = klines.slice(-5);
            const currentPrice = parseFloat(currentMarketData.find(item => item.symbol === symbol)?.lastPrice || 0);
            const openPrice = parseFloat(currentMarketData.find(item => item.symbol === symbol)?.openPrice || 0);
            
            // 1. Check for long upper wick (3-5 minute candle)
            for (let i = Math.max(0, recentCandles.length - 3); i < recentCandles.length; i++) {
                const candle = recentCandles[i];
                const high = parseFloat(candle[2]);
                const low = parseFloat(candle[3]);
                const open = parseFloat(candle[1]);
                const close = parseFloat(candle[4]);
                
                const bodyHeight = Math.abs(close - open);
                const upperWick = high - Math.max(open, close);
                const lowerWick = Math.min(open, close) - low;
                const totalRange = high - low;
                
                // Long upper wick condition: upper wick > 2x body height and > 30% of total range
                if (upperWick > bodyHeight * 2 && upperWick > totalRange * 0.3) {
                    return { type: 'long_upper_wick', confidence: 'high' };
                }
            }
            
            // 2. Check for momentum slowdown (smaller candle after big pump)
            if (recentCandles.length >= 3) {
                const lastCandle = recentCandles[recentCandles.length - 1];
                const prevCandle = recentCandles[recentCandles.length - 2];
                const prevPrevCandle = recentCandles[recentCandles.length - 3];
                
                const lastBody = Math.abs(parseFloat(lastCandle[4]) - parseFloat(lastCandle[1]));
                const prevBody = Math.abs(parseFloat(prevCandle[4]) - parseFloat(prevCandle[1]));
                const prevPrevBody = Math.abs(parseFloat(prevPrevCandle[4]) - parseFloat(prevPrevCandle[1]));
                
                // Check if previous candle was big and current candle is small (momentum slowdown)
                if (prevBody > prevPrevBody * 1.5 && lastBody < prevBody * 0.5) {
                    return { type: 'momentum_slowdown', confidence: 'medium' };
                }
            }
            
            return null;
        }

        // Calculate fees for trade
        function calculateFees() {
            const entryPrice = parseFloat(document.getElementById('entryPrice').value);
            const tradeSize = parseFloat(document.getElementById('tradeSize').value);
            const leverage = parseInt(document.getElementById('tradeLeverage').value);
            const takeProfit = parseFloat(document.getElementById('takeProfit').value);
            
            if (!entryPrice || !tradeSize) {
                document.getElementById('feeDisplay').style.display = 'none';
                return;
            }
            
            // Get fee settings
            const takerFeePercent = parseFloat(document.getElementById('takerFee').value) || 0.04;
            const makerFeePercent = parseFloat(document.getElementById('makerFee').value) || 0.02;
            
            // Calculate position value with leverage
            const positionValue = tradeSize * leverage;
            
            // Calculate fees based on order type
            let entryFeePercent, exitFeePercent;
            if (orderType === 'market') {
                entryFeePercent = takerFeePercent;
                exitFeePercent = makerFeePercent; // Assume maker for exit on TP/SL
            } else {
                entryFeePercent = makerFeePercent; // Limit and stop limit orders are maker
                exitFeePercent = makerFeePercent;
            }
            
            const entryFee = (positionValue * entryFeePercent) / 100;
            const exitFee = (positionValue * exitFeePercent) / 100;
            
            // Calculate take profit price
            const side = document.getElementById('tradeSide').value;
            let tpPrice;
            if (side === 'long') {
                tpPrice = entryPrice * (1 + takeProfit / 100);
            } else {
                tpPrice = entryPrice * (1 - takeProfit / 100);
            }
            
            // Calculate profit before fees
            let profitBeforeFees;
            if (side === 'long') {
                profitBeforeFees = (tpPrice - entryPrice) / entryPrice * 100 * leverage;
            } else {
                profitBeforeFees = (entryPrice - tpPrice) / entryPrice * 100 * leverage;
            }
            
            // Calculate total fees in percentage
            const totalFeesUSD = entryFee + exitFee;
            const totalFeesPercent = (totalFeesUSD / tradeSize) * 100;
            
            // Calculate breakeven after fees
            const breakevenAfterFees = (totalFeesPercent / leverage) + (totalFeesPercent / leverage * (entryFeePercent + exitFeePercent) / 100);
            
            // Update display
            document.getElementById('takerFeeValue').textContent = takerFeePercent.toFixed(3) + '%';
            document.getElementById('makerFeeValue').textContent = makerFeePercent.toFixed(3) + '%';
            document.getElementById('entryFeeValue').textContent = '$' + entryFee.toFixed(4);
            document.getElementById('exitFeeValue').textContent = '$' + exitFee.toFixed(4);
            document.getElementById('totalFeeValue').textContent = '$' + totalFeesUSD.toFixed(4);
            document.getElementById('breakevenValue').textContent = breakevenAfterFees.toFixed(3) + '%';
            
            document.getElementById('feeDisplay').style.display = 'block';
        }

        // Search all coins (not just USDT pairs from 24hr data)
        async function searchAllCoins() {
            const searchTerm = document.getElementById('globalSearch').value.trim().toUpperCase();
            const resultsDiv = document.getElementById('searchResults');
            
            if (searchTerm.length < 1) {
                resultsDiv.style.display = 'none';
                return;
            }
            
            // Filter from all coins data
            const filtered = allCoinsData
                .filter(coin => 
                    coin.symbol.includes(searchTerm) || 
                    coin.baseAsset.includes(searchTerm)
                )
                .slice(0, 15);
            
            if (filtered.length === 0) {
                resultsDiv.innerHTML = '<div class="search-result-item">No results found</div>';
                resultsDiv.style.display = 'block';
                return;
            }
            
            // Try to get price data for filtered coins
            const symbols = filtered.map(coin => coin.symbol);
            let priceData = [];
            
            try {
                const priceResponse = await fetch(`https://fapi.binance.com/fapi/v1/ticker/24hr?symbols=${JSON.stringify(symbols)}`);
                priceData = await priceResponse.json();
            } catch (e) {
                // If batch request fails, get data individually
                priceData = currentMarketData.filter(item => 
                    symbols.includes(item.symbol)
                );
            }
            
            let html = '';
            filtered.forEach(coin => {
                const priceInfo = priceData.find(p => p.symbol === coin.symbol);
                const changePercent = priceInfo ? parseFloat(priceInfo.priceChangePercent) : 0;
                const lastPrice = priceInfo ? parseFloat(priceInfo.lastPrice) : 0;
                const openPrice = priceInfo ? parseFloat(priceInfo.openPrice) : 0;
                const changeFromOpen = openPrice > 0 ? ((lastPrice - openPrice) / openPrice) * 100 : 0;
                
                const isInWatchlist = watchlist.has(coin.symbol);
                const isTracked = trackedPrices[coin.symbol];
                const isPositive = changeFromOpen >= 0;
                
                html += `
                    <div class="search-result-item" onclick="selectSymbolFromSearch('${coin.symbol}')">
                        <div class="search-result-info">
                            <div class="search-result-symbol">${coin.symbol}</div>
                            <div class="search-result-name">${coin.baseAsset} / ${coin.quoteAsset}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: 600; font-size: 15px; margin-bottom: 4px;">
                                ${lastPrice > 0 ? '$' + lastPrice.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 8}) : 'N/A'}
                            </div>
                            ${priceInfo ? `
                                <div class="search-result-change ${isPositive ? 'positive' : 'negative'}">
                                    ${changeFromOpen.toFixed(2)}%
                                </div>
                            ` : ''}
                        </div>
                        <button class="action-btn ${isTracked ? 'tracking' : 'track'}" onclick="event.stopPropagation(); ${isTracked ? `stopTracking('${coin.symbol}')` : `startTracking('${coin.symbol}')`}">
                            <i class="fas fa-${isTracked ? 'check-circle' : 'crosshairs'}"></i>
                        </button>
                        <button class="action-btn watchlist" onclick="event.stopPropagation(); ${isInWatchlist ? `removeFromWatchlist('${coin.symbol}')` : `addToWatchlist('${coin.symbol}')`}">
                            <i class="fas ${isInWatchlist ? 'fa-star' : 'fa-star'}"></i>
                        </button>
                    </div>
                `;
            });
            
            resultsDiv.innerHTML = html;
            resultsDiv.style.display = 'block';
        }

        function selectSymbolFromSearch(symbol) {
            const searchInput = document.getElementById('globalSearch');
            searchInput.value = symbol;
            document.getElementById('searchResults').style.display = 'none';
            
            // Find the coin in market data
            const coinData = currentMarketData.find(item => item.symbol === symbol);
            if (coinData) {
                selectSymbolForTrading(symbol, coinData);
                switchTab('trading');
            }
        }

        function selectSymbolForTrading(symbol, coinData = null) {
            selectedSymbol = symbol;
            selectedSymbolData = coinData || currentMarketData.find(item => item.symbol === symbol);
            
            if (selectedSymbolData) {
                document.getElementById('selectedSymbolInfo').style.display = 'flex';
                document.getElementById('selectedCoinIcon').textContent = symbol.replace('USDT', '').substring(0, 3);
                document.getElementById('selectedSymbolName').textContent = symbol;
                document.getElementById('selectedSymbolPrice').textContent = 
                    '$' + parseFloat(selectedSymbolData.lastPrice).toLocaleString('en-US', {
                        minimumFractionDigits: 2,
                        maximumFractionDigits: 8
                    });
                
                const openPrice = parseFloat(selectedSymbolData.openPrice);
                const lastPrice = parseFloat(selectedSymbolData.lastPrice);
                const changeFromOpen = openPrice > 0 ? ((lastPrice - openPrice) / openPrice) * 100 : 0;
                
                const changeElement = document.getElementById('selectedSymbolChange');
                changeElement.textContent = `${changeFromOpen >= 0 ? '+' : ''}${changeFromOpen.toFixed(2)}%`;
                changeElement.className = `selected-symbol-change ${changeFromOpen >= 0 ? 'positive' : 'negative'}`;
                
                // Set entry price
                const entryPriceInput = document.getElementById('entryPrice');
                const limitPriceInput = document.getElementById('limitPrice');
                const currentPrice = parseFloat(selectedSymbolData.lastPrice);
                
                entryPriceInput.value = currentPrice;
                if (orderType === 'limit') {
                    limitPriceInput.value = currentPrice;
                }
                
                // Update stop limit prices if that order type is selected
                if (orderType === 'stop_limit') {
                    updateStopLimitPrices();
                }
                
                // Calculate fees
                calculateFees();
            }
        }

        function clearSelectedSymbol() {
            selectedSymbol = null;
            selectedSymbolData = null;
            document.getElementById('selectedSymbolInfo').style.display = 'none';
            document.getElementById('entryPrice').value = '';
            document.getElementById('limitPrice').value = '';
            document.getElementById('feeDisplay').style.display = 'none';
        }

        function updateSelectedSymbolInfo() {
            if (selectedSymbol && selectedSymbolData) {
                const coinData = currentMarketData.find(item => item.symbol === selectedSymbol);
                if (coinData) {
                    selectedSymbolData = coinData;
                    const openPrice = parseFloat(coinData.openPrice);
                    const lastPrice = parseFloat(coinData.lastPrice);
                    const changeFromOpen = openPrice > 0 ? ((lastPrice - openPrice) / openPrice) * 100 : 0;
                    
                    document.getElementById('selectedSymbolPrice').textContent = 
                        '$' + parseFloat(coinData.lastPrice).toLocaleString('en-US', {
                            minimumFractionDigits: 2,
                            maximumFractionDigits: 8
                        });
                    
                    const changeElement = document.getElementById('selectedSymbolChange');
                    changeElement.textContent = `${changeFromOpen >= 0 ? '+' : ''}${changeFromOpen.toFixed(2)}%`;
                    changeElement.className = `selected-symbol-change ${changeFromOpen >= 0 ? 'positive' : 'negative'}`;
                }
            }
        }

        // Update market tables with distance from high/low and rejection indicators
        function updateMarketTables() {
            const sortedData = [...currentMarketData].map(item => {
                const openPrice = parseFloat(item.openPrice);
                const lastPrice = parseFloat(item.lastPrice);
                const changeFromOpen = openPrice > 0 ? ((lastPrice - openPrice) / openPrice) * 100 : 0;
                return { ...item, changeFromOpen };
            }).sort((a, b) => {
                return b.changeFromOpen - a.changeFromOpen;
            });
            
            const gainers = sortedData.slice(0, 50);
            const losers = sortedData.slice(-50).reverse();
            
            renderTableWithDistanceAndRejection('gainersTable', gainers);
            renderTableWithDistanceAndRejection('losersTable', losers);
        }

        function renderTableWithDistanceAndRejection(tableId, data) {
            const tbody = document.querySelector(`#${tableId} tbody`);
            tbody.innerHTML = '';
            
            data.forEach(item => {
                const lastPrice = parseFloat(item.lastPrice);
                const openPrice = parseFloat(item.openPrice);
                const highPrice = parseFloat(item.highPrice);
                const lowPrice = parseFloat(item.lowPrice);
                const changeFromOpen = item.changeFromOpen;
                const volume = parseFloat(item.volume);
                const quoteVolume = parseFloat(item.quoteVolume);
                
                // Calculate distance from high and low
                const distanceFromHigh = ((highPrice - lastPrice) / highPrice) * 100;
                const distanceFromLow = ((lastPrice - lowPrice) / lastPrice) * 100;
                const rangePercent = ((highPrice - lowPrice) / lowPrice) * 100;
                
                const currentPosition = ((lastPrice - lowPrice) / (highPrice - lowPrice)) * 100;
                const isPositive = changeFromOpen >= 0;
                const isInWatchlist = watchlist.has(item.symbol);
                const isTracked = trackedPrices[item.symbol];
                
                // Check for rejection patterns
                const rejectionPattern = checkRejectionPattern(item.symbol);
                const hasRejection = rejectionPattern !== null;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div class="coin-cell">
                            <div class="coin-icon">${item.symbol.replace('USDT', '').substring(0, 3)}</div>
                            <div class="coin-info">
                                <div class="coin-symbol">${item.symbol}</div>
                                <div class="coin-name">${item.symbol.replace('USDT', '')}</div>
                            </div>
                        </div>
                    </td>
                    <td class="price-cell">$${lastPrice.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 8})}</td>
                    <td>
                        <div class="change-badge ${isPositive ? 'positive' : 'negative'}">
                            <i class="fas fa-${isPositive ? 'arrow-up' : 'arrow-down'}"></i>
                            ${changeFromOpen.toFixed(2)}%
                        </div>
                    </td>
                    <td>
                        <div>$${lowPrice.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 8})} - $${highPrice.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 8})}</div>
                        <div class="high-low-progress">
                            <div class="high-low-fill" style="width: 100%; opacity: 0.2;"></div>
                            <div class="current-position" style="left: ${currentPosition}%;"></div>
                        </div>
                        <div class="high-low-text">
                            <span>${rangePercent.toFixed(2)}% range</span>
                            <span>${currentPosition.toFixed(1)}% position</span>
                        </div>
                    </td>
                    <td>
                        <div>$${(quoteVolume / 1000000).toFixed(2)}M</div>
                        <div class="volume-bar">
                            <div class="volume-fill" style="width: ${Math.min(volume / 100000, 100)}%;"></div>
                        </div>
                    </td>
                    <td>
                        ${hasRejection ? `
                            <div class="rejection-indicator ${rejectionPattern.confidence === 'high' ? '' : 'warning'}">
                                <i class="fas fa-exclamation-triangle"></i>
                                REJECTION
                                <span style="font-size: 9px; opacity: 0.8;">${rejectionPattern.type.replace('_', ' ')}</span>
                            </div>
                        ` : '<div style="font-size: 11px; color: var(--light-3);">No rejection</div>'}
                    </td>
                    <td>
                        <div class="actions-cell">
                            <button class="action-btn long" onclick="enterTradeFromMarket('${item.symbol}', 'long')">
                                <i class="fas fa-arrow-up"></i>
                                LONG
                            </button>
                            <button class="action-btn short" onclick="enterTradeFromMarket('${item.symbol}', 'short')">
                                <i class="fas fa-arrow-down"></i>
                                SHORT
                            </button>
                            <button class="action-btn ${isTracked ? 'tracking' : 'track'}" onclick="event.stopPropagation(); ${isTracked ? `stopTracking('${item.symbol}')` : `startTracking('${item.symbol}')`}">
                                <i class="fas fa-${isTracked ? 'check-circle' : 'crosshairs'}"></i>
                                ${isTracked ? 'Tracking' : 'Track'}
                            </button>
                            <button class="action-btn watchlist" onclick="event.stopPropagation(); ${isInWatchlist ? `removeFromWatchlist('${item.symbol}')` : `addToWatchlist('${item.symbol}')`}">
                                <i class="fas ${isInWatchlist ? 'fa-star' : 'fa-star'}"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // Update watchlist with REDESIGNED tracking section
        function updateWatchlistDisplay() {
            const tbody = document.querySelector('#watchlistTable tbody');
            const loading = document.getElementById('watchlistLoading');
            
            if (watchlist.size === 0) {
                document.getElementById('watchlistTable').style.display = 'none';
                loading.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="fas fa-star"></i>
                        </div>
                        <div class="empty-state-title">Watchlist is Empty</div>
                        <div class="empty-state-description">
                            Add symbols from the Market View or search bar
                        </div>
                        <button class="btn btn-primary" onclick="addCustomSymbol()" style="margin-top: 16px;">
                            <i class="fas fa-plus"></i>
                            Add Your First Symbol
                        </button>
                    </div>
                `;
                loading.style.display = 'block';
                document.getElementById('watchlistCount').textContent = '0';
                return;
            }
            
            loading.style.display = 'none';
            document.getElementById('watchlistTable').style.display = 'table';
            document.getElementById('watchlistCount').textContent = watchlist.size;
            
            tbody.innerHTML = '';
            
            const watchlistData = currentMarketData
                .filter(item => watchlist.has(item.symbol))
                .map(item => {
                    const openPrice = parseFloat(item.openPrice);
                    const lastPrice = parseFloat(item.lastPrice);
                    const changeFromOpen = openPrice > 0 ? ((lastPrice - openPrice) / openPrice) * 100 : 0;
                    return { ...item, changeFromOpen };
                })
                .sort((a, b) => b.changeFromOpen - a.changeFromOpen);
            
            watchlistData.forEach(item => {
                const lastPrice = parseFloat(item.lastPrice);
                const highPrice = parseFloat(item.highPrice);
                const lowPrice = parseFloat(item.lowPrice);
                const changeFromOpen = item.changeFromOpen;
                
                // Calculate distances
                const distanceFromHigh = ((highPrice - lastPrice) / highPrice) * 100;
                const distanceFromLow = ((lastPrice - lowPrice) / lastPrice) * 100;
                
                const currentPosition = ((lastPrice - lowPrice) / (highPrice - lowPrice)) * 100;
                const isPositive = changeFromOpen >= 0;
                const isTracked = trackedPrices[item.symbol];
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <div class="coin-cell">
                            <div class="coin-icon">${item.symbol.replace('USDT', '').substring(0, 3)}</div>
                            <div class="coin-info">
                                <div class="coin-symbol">${item.symbol}</div>
                                <div class="coin-name">${item.symbol.replace('USDT', '')}</div>
                            </div>
                        </div>
                    </td>
                    <td class="price-cell">$${lastPrice.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 8})}</td>
                    <td>
                        <div class="change-badge ${isPositive ? 'positive' : 'negative'}">
                            <i class="fas fa-${isPositive ? 'arrow-up' : 'arrow-down'}"></i>
                            ${changeFromOpen.toFixed(2)}%
                        </div>
                    </td>
                    <td>
                        <div>$${lowPrice.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 8})} - $${highPrice.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 8})}</div>
                        <div class="high-low-progress">
                            <div class="high-low-fill" style="width: 100%; opacity: 0.2;"></div>
                            <div class="current-position" style="left: ${currentPosition}%;"></div>
                        </div>
                        <div class="high-low-text">
                            <span>Low</span>
                            <span>High</span>
                        </div>
                    </td>
                    <td>
                        <div style="margin-bottom: 8px;">
                            <span class="distance-indicator distance-from-high">
                                <i class="fas fa-arrow-down"></i>
                                ${distanceFromHigh.toFixed(2)}% from 24h high
                            </span>
                        </div>
                        <div>
                            <span class="distance-indicator distance-from-low">
                                <i class="fas fa-arrow-up"></i>
                                ${distanceFromLow.toFixed(2)}% from 24h low
                            </span>
                        </div>
                    </td>
                    <td>
                        <div class="actions-cell">
                            <button class="action-btn long" onclick="enterTradeFromMarket('${item.symbol}', 'long')">
                                <i class="fas fa-arrow-up"></i>
                                LONG
                            </button>
                            <button class="action-btn short" onclick="enterTradeFromMarket('${item.symbol}', 'short')">
                                <i class="fas fa-arrow-down"></i>
                                SHORT
                            </button>
                            <button class="action-btn ${isTracked ? 'tracking' : 'track'}" onclick="${isTracked ? `stopTracking('${item.symbol}')` : `startTracking('${item.symbol}')`}">
                                <i class="fas fa-${isTracked ? 'check-circle' : 'crosshairs'}"></i>
                                ${isTracked ? 'Tracking' : 'Track'}
                            </button>
                            <button class="action-btn watchlist" onclick="removeFromWatchlist('${item.symbol}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                // Add tracked prices display if being tracked - REDESIGNED
                if (isTracked) {
                    const trackedInfo = trackedPrices[item.symbol];
                    const trackedPrice = trackedInfo.trackedPrice;
                    const longEntryPercent = trackedInfo.longEntryPercent || 1;
                    const shortEntryPercent = trackedInfo.shortEntryPercent || 1;
                    
                    // Calculate entry prices based on tracked price
                    const longEntryPrice = trackedPrice * (1 - longEntryPercent / 100);
                    const shortEntryPrice = trackedPrice * (1 + shortEntryPercent / 100);
                    
                    // Calculate current price movement from tracked price
                    const priceMovementFromTracked = ((lastPrice - trackedPrice) / trackedPrice) * 100;
                    
                    // Calculate distance to entry levels from current price
                    const distanceToLongEntry = ((longEntryPrice - lastPrice) / lastPrice) * 100;
                    const distanceToShortEntry = ((shortEntryPrice - lastPrice) / lastPrice) * 100;
                    
                    // Calculate max moves with PRICE VALUES
                    const maxUpMove = trackedInfo.maxUpMove || 0;
                    const maxDownMove = trackedInfo.maxDownMove || 0;
                    const maxUpMovePrice = trackedPrice * (1 + maxUpMove / 100);
                    const maxDownMovePrice = trackedPrice * (1 + maxDownMove / 100);
                    
                    // Update max moves
                    if (priceMovementFromTracked > maxUpMove) {
                        trackedInfo.maxUpMove = priceMovementFromTracked;
                        trackedInfo.maxUpMovePrice = trackedPrice * (1 + priceMovementFromTracked / 100);
                    }
                    if (priceMovementFromTracked < maxDownMove) {
                        trackedInfo.maxDownMove = priceMovementFromTracked;
                        trackedInfo.maxDownMovePrice = trackedPrice * (1 + priceMovementFromTracked / 100);
                    }
                    
                    // Calculate time since tracking started
                    const trackedTime = new Date(trackedInfo.trackedTime);
                    const now = new Date();
                    const hoursTracked = (now - trackedTime) / (1000 * 60 * 60);
                    
                    const trackedDiv = document.createElement('div');
                    trackedDiv.className = 'tracked-prices';
                    trackedDiv.innerHTML = `
                        <div class="tracked-header">
                            <div class="tracked-title">
                                <i class="fas fa-crosshairs"></i>
                                <span>Price Tracking</span>
                            </div>
                            <div class="tracked-time">
                                Tracked ${hoursTracked.toFixed(1)}h ago
                            </div>
                        </div>
                        
                        <!-- Current vs Tracked Price -->
                        <div class="current-vs-tracked">
                            <div class="current-price-info">
                                <div class="current-price-label">Current Price</div>
                                <div class="current-price-value">$${lastPrice.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 8})}</div>
                            </div>
                            <div style="display: flex; flex-direction: column; align-items: flex-end;">
                                <div style="font-size: 11px; color: var(--light-3); margin-bottom: 2px;">
                                    Tracked: $${trackedPrice.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 8})}
                                </div>
                                <div class="price-diff ${priceMovementFromTracked >= 0 ? 'positive' : 'negative'}">
                                    ${priceMovementFromTracked >= 0 ? '+' : ''}${priceMovementFromTracked.toFixed(2)}%
                                </div>
                            </div>
                        </div>
                        
                        <!-- Movement Statistics with PRICE VALUES -->
                        <div class="movement-stats-grid">
                            <div class="movement-stat">
                                <div class="movement-stat-label">Max Up Move</div>
                                <div class="movement-stat-percent positive">+${maxUpMove.toFixed(2)}%</div>
                                <div class="movement-stat-price">$${maxUpMovePrice.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 8})}</div>
                            </div>
                            <div class="movement-stat">
                                <div class="movement-stat-label">Max Down Move</div>
                                <div class="movement-stat-percent negative">${maxDownMove.toFixed(2)}%</div>
                                <div class="movement-stat-price">$${maxDownMovePrice.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 8})}</div>
                            </div>
                        </div>
                        
                        <!-- Movement Visualization -->
                        <div class="movement-chart">
                            <div class="movement-line">
                                <div class="movement-tracked" style="left: 50%;"></div>
                                <div class="movement-current" style="left: ${50 + (priceMovementFromTracked * 2)}%;"></div>
                                <div class="movement-long" style="left: ${50 - (longEntryPercent * 2)}%;"></div>
                                <div class="movement-short" style="left: ${50 + (shortEntryPercent * 2)}%;"></div>
                            </div>
                        </div>
                        <div class="movement-labels">
                            <span>Long Entry</span>
                            <span>Tracked</span>
                            <span>Short Entry</span>
                        </div>
                        
                        <!-- Entry Prices with PRICE and PERCENTAGE -->
                        <div class="tracked-prices-row">
                            <div class="tracked-price-item">
                                <div class="tracked-price-label">Long Entry (${longEntryPercent}% below)</div>
                                <div class="price-with-percent">
                                    <div class="price-main">$${longEntryPrice.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 8})}</div>
                                    <div class="price-percent ${distanceToLongEntry <= 0 ? 'positive' : 'negative'}">
                                        ${distanceToLongEntry <= 0 ? 'Above entry' : 'Below entry'} ${Math.abs(distanceToLongEntry).toFixed(2)}%
                                    </div>
                                </div>
                            </div>
                            <div class="tracked-price-item">
                                <div class="tracked-price-label">Short Entry (${shortEntryPercent}% above)</div>
                                <div class="price-with-percent">
                                    <div class="price-main">$${shortEntryPrice.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 8})}</div>
                                    <div class="price-percent ${distanceToShortEntry <= 0 ? 'positive' : 'negative'}">
                                        ${distanceToShortEntry <= 0 ? 'Below entry' : 'Above entry'} ${Math.abs(distanceToShortEntry).toFixed(2)}%
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Quick Trade Buttons -->
                        <div class="tracked-trade-buttons">
                            <button class="tracked-trade-btn long" onclick="placeStopLimitFromTracked('${item.symbol}', 'long', ${longEntryPrice})">
                                <i class="fas fa-flag"></i>
                                Stop Limit Long
                            </button>
                            <button class="tracked-trade-btn short" onclick="placeStopLimitFromTracked('${item.symbol}', 'short', ${shortEntryPrice})">
                                <i class="fas fa-flag"></i>
                                Stop Limit Short
                            </button>
                        </div>
                        
                        <div style="font-size: 10px; color: var(--light-3); margin-top: 12px; text-align: center; padding-top: 8px; border-top: 1px solid rgba(139, 92, 246, 0.2);">
                            <i class="fas fa-info-circle"></i> Price moved ${priceMovementFromTracked >= 0 ? '+' : ''}${priceMovementFromTracked.toFixed(2)}% since tracking started
                        </div>
                    `;
                    
                    // Insert after the row
                    const newRow = document.createElement('tr');
                    const newCell = document.createElement('td');
                    newCell.colSpan = 6;
                    newCell.appendChild(trackedDiv);
                    newRow.appendChild(newCell);
                    
                    tbody.appendChild(row);
                    tbody.appendChild(newRow);
                } else {
                    tbody.appendChild(row);
                }
            });
            
            // Save updated tracking info
            saveToStorage();
        }

        // Place stop limit order from tracked price
        function placeStopLimitFromTracked(symbol, side, entryPrice) {
            selectSymbolForTrading(symbol);
            
            // Set order type to stop limit
            setOrderType('stop_limit');
            
            // Set trade side
            document.getElementById('tradeSide').value = side;
            
            // Calculate stop and limit prices based on entry price
            const currentPrice = parseFloat(selectedSymbolData.lastPrice);
            const stopPercent = parseFloat(document.getElementById('defaultStopPercent').value) || 2;
            const limitOffset = parseFloat(document.getElementById('defaultLimitOffset').value) || 0.1;
            
            let stopPrice, limitPrice;
            
            if (side === 'long') {
                // For long: stop at entry price (price drops to reach long entry)
                stopPrice = entryPrice;
                limitPrice = entryPrice * (1 + limitOffset / 100);
            } else {
                // For short: stop at entry price (price rises to reach short entry)
                stopPrice = entryPrice;
                limitPrice = entryPrice * (1 - limitOffset / 100);
            }
            
            // Set the prices
            document.getElementById('stopPrice').value = stopPrice.toFixed(8);
            document.getElementById('stopLimitPrice').value = limitPrice.toFixed(8);
            document.getElementById('entryPrice').value = limitPrice.toFixed(8);
            
            // Update display
            updateStopLimitInfo();
            
            // Switch to trading tab
            switchTab('trading');
            
            showAlert(`Stop limit ${side} order prepared for ${symbol} at $${entryPrice.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 8})}`, 'info');
        }

        // Track price functions
        function startTracking(symbol) {
            const coinData = currentMarketData.find(item => item.symbol === symbol);
            if (!coinData) {
                showAlert('Symbol data not found', 'warning');
                return;
            }
            
            const currentPrice = parseFloat(coinData.lastPrice);
            const highPrice = parseFloat(coinData.highPrice);
            const lowPrice = parseFloat(coinData.lowPrice);
            const distanceFromHigh = ((highPrice - currentPrice) / highPrice) * 100;
            const distanceFromLow = ((currentPrice - lowPrice) / currentPrice) * 100;
            
            // Get current entry percentages
            const longEntryPercent = parseFloat(document.getElementById('longEntryPercent').value) || 1;
            const shortEntryPercent = parseFloat(document.getElementById('shortEntryPercent').value) || 1;
            
            // Calculate entry prices based on tracked price and percentages
            const longEntryPrice = currentPrice * (1 - longEntryPercent / 100);
            const shortEntryPrice = currentPrice * (1 + shortEntryPercent / 100);
            
            // Store the frozen tracked price and entry prices
            trackedPrices[symbol] = {
                trackedPrice: currentPrice, // FROZEN price
                trackedTime: new Date().toISOString(),
                distanceFromHigh: distanceFromHigh,
                distanceFromLow: distanceFromLow,
                currentPriceAtTrack: currentPrice,
                longEntryPercent: longEntryPercent,
                shortEntryPercent: shortEntryPercent,
                longEntryPrice: longEntryPrice,
                shortEntryPrice: shortEntryPrice,
                maxUpMove: 0,
                maxDownMove: 0,
                maxUpMovePrice: currentPrice,
                maxDownMovePrice: currentPrice
            };
            
            saveToStorage();
            updateWatchlistDisplay();
            updateMarketTables();
            
            showAlert(`Started tracking ${symbol} at $${currentPrice.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 8})}. Long entry: $${longEntryPrice.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 8})} (${longEntryPercent}% below), Short entry: $${shortEntryPrice.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 8})} (${shortEntryPercent}% above).`, 'success');
        }

        function stopTracking(symbol) {
            if (trackedPrices[symbol]) {
                delete trackedPrices[symbol];
                saveToStorage();
                updateWatchlistDisplay();
                updateMarketTables();
                showAlert(`Stopped tracking ${symbol}`, 'info');
            }
        }

        function updateTrackedPricesDisplay() {
            Object.keys(trackedPrices).forEach(symbol => {
                const trackedInfo = trackedPrices[symbol];
                const coinData = currentMarketData.find(item => item.symbol === symbol);
                
                if (coinData) {
                    const currentPrice = parseFloat(coinData.lastPrice);
                    
                    // Update current price movement
                    const priceMovement = ((currentPrice - trackedInfo.trackedPrice) / trackedInfo.trackedPrice) * 100;
                    
                    // Check if price has reached entry levels
                    const longEntryPrice = trackedInfo.longEntryPrice || (trackedInfo.trackedPrice * (1 - (trackedInfo.longEntryPercent || 1) / 100));
                    const shortEntryPrice = trackedInfo.shortEntryPrice || (trackedInfo.trackedPrice * (1 + (trackedInfo.shortEntryPercent || 1) / 100));
                    
                    // Check notification cooldown
                    const now = Date.now();
                    const lastNotification = lastNotificationTime[symbol] || 0;
                    
                    // Check if price is near long entry (price drops to long entry)
                    if (currentPrice <= longEntryPrice * 1.001 && now - lastNotification > notificationCooldown) {
                        showAlert(`${symbol} is near LONG entry price (${trackedInfo.longEntryPercent || 1}% below tracked). Current: $${currentPrice.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 8})}, Entry: $${longEntryPrice.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 8})}`, 'info');
                        lastNotificationTime[symbol] = now;
                    }
                    
                    // Check if price is near short entry (price rises to short entry)
                    if (currentPrice >= shortEntryPrice * 0.999 && now - lastNotification > notificationCooldown) {
                        showAlert(`${symbol} is near SHORT entry price (${trackedInfo.shortEntryPercent || 1}% above tracked). Current: $${currentPrice.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 8})}, Entry: $${shortEntryPrice.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 8})}`, 'info');
                        lastNotificationTime[symbol] = now;
                    }
                }
            });
        }

        // Check pending orders
        function checkPendingOrders() {
            pendingOrders.forEach((order, index) => {
                const marketItem = currentMarketData.find(item => item.symbol === order.symbol);
                if (!marketItem) return;
                
                const currentPrice = parseFloat(marketItem.lastPrice);
                let shouldTrigger = false;
                let fillPrice = currentPrice;
                
                if (order.orderType === 'limit') {
                    // Limit order logic
                    if (order.side === 'long') {
                        // Long limit order: triggers when price drops TO or BELOW limit price
                        shouldTrigger = currentPrice <= order.entryPrice;
                    } else {
                        // Short limit order: triggers when price rises TO or ABOVE limit price
                        shouldTrigger = currentPrice >= order.entryPrice;
                    }
                    
                    if (shouldTrigger) {
                        fillPrice = order.entryPrice;
                    }
                    
                } else if (order.orderType === 'stop_limit') {
                    // Stop limit order logic (two-step process)
                    if (order.side === 'long') {
                        // Long stop limit: price rises TO or ABOVE stop price, then triggers limit at limitPrice
                        if (currentPrice >= order.stopPrice) {
                            // Stop triggered, now check if limit can be filled
                            shouldTrigger = currentPrice <= order.limitPrice;
                            fillPrice = order.limitPrice;
                        }
                    } else {
                        // Short stop limit: price drops TO or BELOW stop price, then triggers limit at limitPrice
                        if (currentPrice <= order.stopPrice) {
                            // Stop triggered, now check if limit can be filled
                            shouldTrigger = currentPrice >= order.limitPrice;
                            fillPrice = order.limitPrice;
                        }
                    }
                }
                
                if (shouldTrigger) {
                    executePendingOrder(order, index, fillPrice);
                }
            });
        }

        // Execute pending order
        function executePendingOrder(order, index, fillPrice) {
            // Create actual trade from pending order
            const trade = {
                id: Date.now(),
                symbol: order.symbol,
                side: order.side,
                orderType: order.orderType,
                marginMode: order.marginMode,
                leverage: order.leverage,
                entryPrice: fillPrice,
                size: order.size,
                takeProfit: order.takeProfit,
                stopLoss: order.stopLoss,
                comment: `${order.orderType === 'limit' ? 'Limit' : 'Stop Limit'} order filled at $${fillPrice}`,
                entryTime: new Date().toISOString(),
                currentPrice: fillPrice,
                pnl: 0,
                pnlPercent: 0,
                status: 'active',
                closed: false,
                marginMode: order.marginMode,
                marginAllocation: order.marginAllocation,
                marginUsed: order.marginUsed,
                availableMargin: order.availableMargin,
                entryFee: order.entryFee,
                estimatedExitFee: order.estimatedExitFee,
                totalFees: order.totalFees,
                breakevenAfterFees: order.breakevenAfterFees,
                takerFeePercent: order.takerFeePercent,
                makerFeePercent: order.makerFeePercent,
                fundingRate: order.fundingRate,
                pnlAfterFees: 0,
                exitPrice: null,
                exitTime: null,
                duration: null,
                positionValue: order.size * order.leverage
            };

            // Add to active trades
            activeTrades.push(trade);
            
            // Remove from pending orders
            pendingOrders.splice(index, 1);
            saveToStorage();
            
            // Update displays
            updateTradesDisplay();
            updateTradingStats();
            updateDashboard();
            
            // Show alert
            const orderTypeText = order.orderType === 'limit' ? 'Limit' : 'Stop Limit';
            showAlert(`${orderTypeText} ${order.side.toUpperCase()} order filled for ${order.symbol} at $${fillPrice}`, 'success');
        }

        // Trading functions with fee calculation
        function enterTradeFromMarket(symbol, side) {
            selectSymbolForTrading(symbol);
            document.getElementById('tradeSide').value = side;
            switchTab('trading');
        }

        function enterTrade() {
            if (!selectedSymbol) {
                showAlert('Please select a symbol first', 'warning');
                return;
            }
            
            const side = document.getElementById('tradeSide').value;
            const leverage = parseInt(document.getElementById('tradeLeverage').value);
            const entryPrice = parseFloat(document.getElementById('entryPrice').value);
            const limitPrice = orderType === 'limit' ? parseFloat(document.getElementById('limitPrice').value) : null;
            const stopPrice = orderType === 'stop_limit' ? parseFloat(document.getElementById('stopPrice').value) : null;
            const stopLimitPrice = orderType === 'stop_limit' ? parseFloat(document.getElementById('stopLimitPrice').value) : null;
            const size = parseFloat(document.getElementById('tradeSize').value);
            const takeProfit = parseFloat(document.getElementById('takeProfit').value);
            const stopLoss = parseFloat(document.getElementById('stopLoss').value);
            const comment = document.getElementById('tradeComment').value;
            const marginAllocation = marginMode === 'isolated' ? parseFloat(document.getElementById('marginAllocation').value) : 100;
            
            // Get fee settings
            const takerFeePercent = parseFloat(document.getElementById('takerFee').value) || 0.04;
            const makerFeePercent = parseFloat(document.getElementById('makerFee').value) || 0.02;
            const fundingRate = parseFloat(document.getElementById('fundingRate').value) || 0.01;

            if (!entryPrice || !size || !takeProfit || !stopLoss) {
                showAlert('Please fill in all required fields', 'warning');
                return;
            }

            // Calculate margin used
            const availableMargin = parseFloat(document.getElementById('availableMarginInput').value) || 10000;
            const marginUsed = marginMode === 'isolated' ? (availableMargin * marginAllocation / 100) : availableMargin;
            
            // Calculate position value WITH LEVERAGE
            const positionValue = size * leverage;
            
            // Calculate fees based on order type
            let entryFeePercent;
            if (orderType === 'market') {
                entryFeePercent = takerFeePercent;
            } else {
                entryFeePercent = makerFeePercent; // Limit and stop limit orders are maker
            }
            
            const entryFee = (positionValue * entryFeePercent) / 100;
            const estimatedExitFee = (positionValue * makerFeePercent) / 100;
            const totalFees = entryFee + estimatedExitFee;
            
            // Calculate breakeven after fees
            const breakevenAfterFees = (totalFees / size) * 100 / leverage;

            if (orderType === 'market') {
                // Market order - execute immediately
                const trade = {
                    id: Date.now(),
                    symbol: selectedSymbol,
                    side: side,
                    orderType: 'market',
                    marginMode: marginMode,
                    leverage: leverage,
                    entryPrice: entryPrice,
                    size: size,
                    takeProfit: takeProfit,
                    stopLoss: stopLoss,
                    comment: comment,
                    entryTime: new Date().toISOString(),
                    currentPrice: entryPrice,
                    pnl: 0,
                    pnlPercent: 0,
                    status: 'active',
                    closed: false,
                    marginMode: marginMode,
                    marginAllocation: marginAllocation,
                    marginUsed: marginUsed,
                    availableMargin: availableMargin,
                    entryFee: entryFee,
                    estimatedExitFee: estimatedExitFee,
                    totalFees: totalFees,
                    breakevenAfterFees: breakevenAfterFees,
                    takerFeePercent: takerFeePercent,
                    makerFeePercent: makerFeePercent,
                    fundingRate: fundingRate,
                    pnlAfterFees: 0,
                    exitPrice: null,
                    exitTime: null,
                    duration: null,
                    positionValue: positionValue
                };

                activeTrades.push(trade);
                saveToStorage();
                updateTradesDisplay();
                updateTradingStats();
                updateDashboard();
                
                showAlert(`Market ${side.toUpperCase()} trade entered for ${selectedSymbol} at ${leverage}x | Position: $${positionValue.toFixed(2)}`, 'success');
                
            } else if (orderType === 'limit' || orderType === 'stop_limit') {
                // Limit or Stop Limit order - add to pending orders
                const pendingOrder = {
                    id: Date.now(),
                    symbol: selectedSymbol,
                    side: side,
                    orderType: orderType,
                    leverage: leverage,
                    entryPrice: orderType === 'limit' ? limitPrice : stopLimitPrice,
                    stopPrice: orderType === 'stop_limit' ? stopPrice : null,
                    limitPrice: orderType === 'stop_limit' ? stopLimitPrice : null,
                    size: size,
                    takeProfit: takeProfit,
                    stopLoss: stopLoss,
                    comment: comment,
                    createdTime: new Date().toISOString(),
                    status: 'pending',
                    marginMode: marginMode,
                    marginAllocation: marginAllocation,
                    marginUsed: marginUsed,
                    availableMargin: availableMargin,
                    entryFee: entryFee,
                    estimatedExitFee: estimatedExitFee,
                    totalFees: totalFees,
                    breakevenAfterFees: breakevenAfterFees,
                    takerFeePercent: takerFeePercent,
                    makerFeePercent: makerFeePercent,
                    fundingRate: fundingRate
                };

                pendingOrders.push(pendingOrder);
                saveToStorage();
                
                const orderTypeText = orderType === 'limit' ? 'Limit' : 'Stop Limit';
                let message = `${orderTypeText} ${side.toUpperCase()} order placed for ${selectedSymbol}. `;
                
                if (orderType === 'limit') {
                    message += `Will execute at $${limitPrice}`;
                } else {
                    message += `Will trigger at $${stopPrice} and execute at $${stopLimitPrice}`;
                }
                
                showAlert(message, 'success');
                
                // Update displays to show pending order
                updateTradesDisplay();
                updateTradingStats();
                updateDashboard();
            }
            
            resetTradeForm();
        }

        // Live PNL updates
        function updateLivePnl() {
            let totalPnl = 0;
            let totalPnlAfterFees = 0;
            const today = new Date().toDateString();
            let changed = false;
            
            // Only process ACTIVE trades (not pending ones)
            const activeOnlyTrades = activeTrades.filter(t => t.status === 'active' && !t.closed);
            
            activeOnlyTrades.forEach(trade => {
                const marketItem = currentMarketData.find(item => item.symbol === trade.symbol);
                if (marketItem) {
                    const currentPrice = parseFloat(marketItem.lastPrice);
                    const oldPnl = trade.pnl;
                    const oldPnlPercent = trade.pnlPercent;
                    
                    // Calculate new P&L
                    if (trade.side === 'long') {
                        trade.pnlPercent = ((currentPrice - trade.entryPrice) / trade.entryPrice) * 100 * trade.leverage;
                        trade.pnl = trade.size * trade.leverage * (currentPrice - trade.entryPrice) / trade.entryPrice;
                    } else {
                        trade.pnlPercent = ((trade.entryPrice - currentPrice) / trade.entryPrice) * 100 * trade.leverage;
                        trade.pnl = trade.size * trade.leverage * (trade.entryPrice - currentPrice) / trade.entryPrice;
                    }
                    
                    trade.currentPrice = currentPrice;
                    
                    // Calculate P&L after fees
                    trade.pnlAfterFees = trade.pnl - (trade.totalFees || 0);
                    
                    if (Math.abs(oldPnl - trade.pnl) > 0.001 || Math.abs(oldPnlPercent - trade.pnlPercent) > 0.001) {
                        changed = true;
                    }
                    
                    // Check TP/SL
                    if (trade.pnlPercent >= trade.takeProfit) {
                        trade.status = 'closed_tp';
                        trade.exitPrice = currentPrice;
                        trade.exitTime = new Date().toISOString();
                        trade.closed = true;
                        trade.duration = calculateDuration(trade.entryTime, trade.exitTime);
                        
                        recordTodayPnl(trade);
                        tradeHistory.push({...trade});
                        updateTradeHistory();
                        
                        showAlert(`${trade.symbol} hit take profit! P&L: $${trade.pnl.toFixed(2)}`, 'success');
                    } else if (trade.pnlPercent <= -trade.stopLoss) {
                        trade.status = 'closed_sl';
                        trade.exitPrice = currentPrice;
                        trade.exitTime = new Date().toISOString();
                        trade.closed = true;
                        trade.duration = calculateDuration(trade.entryTime, trade.exitTime);
                        
                        recordTodayPnl(trade);
                        tradeHistory.push({...trade});
                        updateTradeHistory();
                        
                        showAlert(`${trade.symbol} hit stop loss! P&L: $${trade.pnl.toFixed(2)}`, 'warning');
                    }
                }
                
                // Accumulate totals
                totalPnl += trade.pnl;
                totalPnlAfterFees += trade.pnlAfterFees;
            });
            
            if (changed) {
                updateTradesDisplay();
                updateTradingStats();
                updateDashboard();
                saveToStorage();
            }
            
            // Update dashboard
            const totalPnlElement = document.getElementById('totalPnlValue');
            totalPnlElement.textContent = '$' + totalPnl.toFixed(2);
            totalPnlElement.className = `stat-value ${totalPnl >= 0 ? 'positive' : 'negative'}`;
            
            updateTodayPnlDisplay();
        }

        function calculateDuration(startTime, endTime) {
            const start = new Date(startTime);
            const end = new Date(endTime);
            const diffMs = end - start;
            
            const days = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diffMs % (1000 * 60)) / 1000);
            
            if (days > 0) return `${days}d ${hours}h`;
            if (hours > 0) return `${hours}h ${minutes}m`;
            if (minutes > 0) return `${minutes}m ${seconds}s`;
            return `${seconds}s`;
        }

        function updateTradesDisplay() {
            const container = document.getElementById('activeTradesList');
            
            // Combine active trades and pending orders for display
            const allItems = [
                ...activeTrades.filter(t => !t.closed),
                ...pendingOrders.map(order => ({
                    id: order.id,
                    symbol: order.symbol,
                    side: order.side,
                    orderType: order.orderType,
                    leverage: order.leverage,
                    entryPrice: order.entryPrice,
                    size: order.size,
                    takeProfit: order.takeProfit,
                    stopLoss: order.stopLoss,
                    comment: order.comment,
                    entryTime: order.createdTime,
                    currentPrice: parseFloat(currentMarketData.find(item => item.symbol === order.symbol)?.lastPrice || order.entryPrice),
                    pnl: 0,
                    pnlPercent: 0,
                    status: 'pending',
                    closed: false,
                    stopPrice: order.stopPrice,
                    limitPrice: order.limitPrice
                }))
            ];
            
            if (allItems.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="fas fa-exchange-alt"></i>
                        </div>
                        <div class="empty-state-title">No Active Trades</div>
                        <div class="empty-state-description">
                            Open your first trade using the form on the left
                        </div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            allItems.forEach(item => {
                const isPending = item.status === 'pending';
                const isStopLimit = item.orderType === 'stop_limit';
                const isLimit = item.orderType === 'limit';
                const sideClass = item.side;
                const marketItem = currentMarketData.find(m => m.symbol === item.symbol);
                const currentPrice = marketItem ? parseFloat(marketItem.lastPrice) : item.currentPrice;
                
                // Calculate progress for pending orders (distance to trigger)
                let progressPercent = 0;
                let progressText = '';
                
                if (isPending) {
                    if (isLimit) {
                        const distance = item.side === 'long' 
                            ? ((currentPrice - item.entryPrice) / currentPrice) * 100
                            : ((item.entryPrice - currentPrice) / currentPrice) * 100;
                        progressPercent = Math.min(Math.abs(distance), 100);
                        progressText = `${distance >= 0 ? 'Above' : 'Below'} entry: ${Math.abs(distance).toFixed(2)}%`;
                    } else if (isStopLimit) {
                        const distanceToStop = item.side === 'long'
                            ? ((currentPrice - item.stopPrice) / currentPrice) * 100
                            : ((item.stopPrice - currentPrice) / currentPrice) * 100;
                        progressPercent = Math.min(Math.abs(distanceToStop), 100);
                        progressText = `${distanceToStop >= 0 ? 'Above' : 'Below'} stop: ${Math.abs(distanceToStop).toFixed(2)}%`;
                    }
                } else {
                    // Regular active trade progress
                    progressPercent = Math.min(Math.abs(item.pnlPercent) / item.takeProfit * 100, 100);
                }
                
                html += `
                    <div class="trade-row ${sideClass} ${isPending ? 'pending' : ''}" data-trade-id="${item.id}">
                        <div class="trade-row-symbol">
                            <div class="trade-row-icon">${item.symbol.replace('USDT', '').substring(0, 3)}</div>
                            <div class="trade-row-symbol-text">
                                <div class="trade-row-symbol-name">${item.symbol}</div>
                                <div class="trade-row-leverage">${item.leverage}x ${isStopLimit ? 'STOP LIMIT' : (isLimit ? 'LIMIT' : 'MARKET')}</div>
                            </div>
                        </div>
                        <div class="trade-row-side ${sideClass}">
                            ${isPending ? 'PENDING' : sideClass.toUpperCase()}
                            ${isPending ? `<span class="stop-limit-badge"><i class="fas fa-${isStopLimit ? 'flag' : 'clock'}"></i> ${isStopLimit ? 'Stop' : 'Limit'}</span>` : ''}
                        </div>
                        <div class="trade-row-prices">
                            <div class="trade-row-price">
                                <span class="trade-row-price-label">${isPending ? 'Target:' : 'Entry:'}</span>
                                <span class="trade-row-price-value">$${item.entryPrice.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 8})}</span>
                            </div>
                            <div class="trade-row-price">
                                <span class="trade-row-price-label">Current:</span>
                                <span class="trade-row-price-value">$${currentPrice.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 8})}</span>
                            </div>
                            ${isStopLimit && isPending ? `
                                <div class="trade-row-price">
                                    <span class="trade-row-price-label">Stop:</span>
                                    <span class="trade-row-price-value">$${item.stopPrice.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 8})}</span>
                                </div>
                            ` : ''}
                        </div>
                        ${!isPending ? `
                            <div class="trade-row-pnl">
                                <div class="trade-row-pnl-value ${item.pnl >= 0 ? 'positive' : 'negative'}">
                                    ${item.pnl >= 0 ? '+' : ''}$${item.pnl.toFixed(2)}
                                </div>
                                <div class="trade-row-pnl-percent ${item.pnl >= 0 ? 'positive' : 'negative'}">
                                    ${item.pnlPercent >= 0 ? '+' : ''}${item.pnlPercent.toFixed(2)}%
                                </div>
                            </div>
                        ` : `
                            <div class="trade-row-pnl">
                                <div class="trade-row-pnl-value" style="color: var(--warning);">
                                    PENDING
                                </div>
                                <div class="trade-row-pnl-percent" style="color: var(--light-3); font-size: 10px;">
                                    ${progressText}
                                </div>
                            </div>
                        `}
                        <div class="trade-row-progress">
                            <div class="trade-row-progress-bar">
                                <div class="trade-row-progress-fill" style="width: ${progressPercent}%;"></div>
                            </div>
                            <div class="trade-row-progress-labels">
                                ${isPending ? `
                                    <span>Waiting...</span>
                                    <span>${isLimit ? 'Limit' : 'Stop Limit'}</span>
                                ` : `
                                    <span>SL: ${item.stopLoss}%</span>
                                    <span>TP: ${item.takeProfit}%</span>
                                `}
                            </div>
                        </div>
                        <div class="trade-row-actions">
                            ${isPending ? `
                                <button class="trade-row-action-btn close" onclick="cancelPendingOrder(${item.id})">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                            ` : `
                                <button class="close-trade-btn" onclick="closeTrade(${item.id})">
                                    <i class="fas fa-times"></i> Close Trade
                                </button>
                                <button class="trade-row-action-btn details" onclick="showTradeDetails(${item.id})">
                                    <i class="fas fa-info"></i> Details
                                </button>
                            `}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function cancelPendingOrder(orderId) {
            // Check in pendingOrders
            const pendingIndex = pendingOrders.findIndex(o => o.id === orderId);
            if (pendingIndex > -1) {
                const removed = pendingOrders.splice(pendingIndex, 1)[0];
                saveToStorage();
                updateTradesDisplay();
                updateTradingStats();
                updateDashboard();
                showAlert(`Pending ${removed.orderType} order ${removed.symbol} cancelled`, 'info');
                return;
            }
        }

        function showTradeDetails(itemId) {
            // Check if it's a pending order
            const pendingOrder = pendingOrders.find(o => o.id === itemId);
            if (pendingOrder) {
                const marketItem = currentMarketData.find(item => item.symbol === pendingOrder.symbol);
                const currentPrice = marketItem ? parseFloat(marketItem.lastPrice) : pendingOrder.entryPrice;
                
                let details = `
Pending ${pendingOrder.orderType === 'limit' ? 'Limit' : 'Stop Limit'} Order
Symbol: ${pendingOrder.symbol}
Side: ${pendingOrder.side.toUpperCase()}
Order Type: ${pendingOrder.orderType === 'limit' ? 'Limit' : 'Stop Limit'}
Leverage: ${pendingOrder.leverage}x
Target Price: $${pendingOrder.entryPrice}
Current Price: $${currentPrice}
Position Size: $${pendingOrder.size}
Take Profit: ${pendingOrder.takeProfit}%
Stop Loss: ${pendingOrder.stopLoss}%
Created: ${new Date(pendingOrder.createdTime).toLocaleString()}
                `;
                
                if (pendingOrder.orderType === 'stop_limit') {
                    details += `\nStop Price: $${pendingOrder.stopPrice}`;
                    details += `\nLimit Price: $${pendingOrder.limitPrice}`;
                    
                    // Calculate distances
                    if (pendingOrder.side === 'long') {
                        const distanceToStop = ((currentPrice - pendingOrder.stopPrice) / currentPrice) * 100;
                        details += `\nDistance to Stop: ${distanceToStop.toFixed(2)}% ${distanceToStop >= 0 ? 'above' : 'below'} stop price`;
                    } else {
                        const distanceToStop = ((pendingOrder.stopPrice - currentPrice) / currentPrice) * 100;
                        details += `\nDistance to Stop: ${distanceToStop.toFixed(2)}% ${distanceToStop >= 0 ? 'below' : 'above'} stop price`;
                    }
                } else {
                    // Limit order
                    if (pendingOrder.side === 'long') {
                        const distanceToEntry = ((currentPrice - pendingOrder.entryPrice) / currentPrice) * 100;
                        details += `\nDistance to Entry: ${distanceToEntry.toFixed(2)}% ${distanceToEntry >= 0 ? 'above' : 'below'} entry price`;
                    } else {
                        const distanceToEntry = ((pendingOrder.entryPrice - currentPrice) / currentPrice) * 100;
                        details += `\nDistance to Entry: ${distanceToEntry.toFixed(2)}% ${distanceToEntry >= 0 ? 'below' : 'above'} entry price`;
                    }
                }
                
                alert(details);
                return;
            }
            
            // Otherwise it's an active trade
            const trade = activeTrades.find(t => t.id === itemId);
            if (trade) {
                let details = `
Symbol: ${trade.symbol}
Side: ${trade.side.toUpperCase()}
Order Type: ${trade.orderType === 'market' ? 'Market' : (trade.orderType === 'stop_limit' ? 'Stop Limit' : 'Limit')}
Margin Mode: ${trade.marginMode === 'isolated' ? 'Isolated' : 'Cross'}
Leverage: ${trade.leverage}x
Entry Price: $${trade.entryPrice}
Position Size: $${trade.size}
Take Profit: ${trade.takeProfit}%
Stop Loss: ${trade.stopLoss}%
Current P&L: $${trade.pnl.toFixed(2)} (${trade.pnlPercent >= 0 ? '+' : ''}${trade.pnlPercent.toFixed(2)}%)
Margin Used: $${(trade.marginUsed || 0).toFixed(2)} (${trade.marginAllocation || 0}%)
Entry Time: ${new Date(trade.entryTime).toLocaleString()}
                `;
                
                alert(details);
            }
        }

        // CLOSE TRADE FUNCTION - User can close trade at any time
        function closeTrade(tradeId) {
            const trade = activeTrades.find(t => t.id === tradeId);
            if (trade) {
                const marketItem = currentMarketData.find(item => item.symbol === trade.symbol);
                const currentPrice = marketItem ? parseFloat(marketItem.lastPrice) : trade.currentPrice;
                
                trade.status = 'closed_manual';
                trade.exitPrice = currentPrice;
                trade.exitTime = new Date().toISOString();
                trade.closed = true;
                trade.duration = calculateDuration(trade.entryTime, trade.exitTime);
                
                // Update P&L for final close
                if (trade.side === 'long') {
                    trade.pnlPercent = ((currentPrice - trade.entryPrice) / trade.entryPrice) * 100 * trade.leverage;
                    trade.pnl = trade.size * trade.leverage * (currentPrice - trade.entryPrice) / trade.entryPrice;
                } else {
                    trade.pnlPercent = ((trade.entryPrice - currentPrice) / trade.entryPrice) * 100 * trade.leverage;
                    trade.pnl = trade.size * trade.leverage * (trade.entryPrice - currentPrice) / trade.entryPrice;
                }
                
                trade.pnlAfterFees = trade.pnl - (trade.totalFees || 0);
                
                // Record today's P&L
                recordTodayPnl(trade);
                
                // Add to history
                tradeHistory.push({...trade});
                updateTradeHistory();
                
                saveToStorage();
                updateTradesDisplay();
                updateTradingStats();
                updateDashboard();
                
                showAlert(`${trade.symbol} closed manually. P&L: $${trade.pnl.toFixed(2)} (After fees: $${trade.pnlAfterFees.toFixed(2)})`, 'info');
            }
        }

        // Trading stats
        function updateTradingStats() {
            const activeCount = activeTrades.filter(t => !t.closed && t.status === 'active').length;
            const pendingCount = pendingOrders.length;
            const closedCount = activeTrades.filter(t => t.closed).length;
            const totalPnl = activeTrades.filter(t => t.status === 'active').reduce((sum, trade) => sum + trade.pnl, 0);
            const totalPnlAfterFees = activeTrades.filter(t => t.status === 'active').reduce((sum, trade) => sum + trade.pnlAfterFees, 0);
            const winTrades = activeTrades.filter(t => t.pnlAfterFees > 0 && t.closed);
            const lossTrades = activeTrades.filter(t => t.pnlAfterFees <= 0 && t.closed);
            const winRate = closedCount > 0 ? (winTrades.length / closedCount) * 100 : 0;
            const totalFees = activeTrades.reduce((sum, trade) => sum + (trade.totalFees || 0), 0);
            
            document.getElementById('activeTradesCount').textContent = activeCount + pendingCount;
            document.getElementById('totalTradesCount').textContent = activeTrades.length;
            
            const statsContainer = document.getElementById('tradingStats');
            statsContainer.innerHTML = `
                <div class="trading-stat">
                    <div class="trading-stat-value">${activeTrades.length}</div>
                    <div class="trading-stat-label">Total Trades</div>
                </div>
                <div class="trading-stat">
                    <div class="trading-stat-value">${activeCount}</div>
                    <div class="trading-stat-label">Active Trades</div>
                </div>
                <div class="trading-stat">
                    <div class="trading-stat-value ${winRate >= 50 ? 'positive' : 'negative'}">${winRate.toFixed(1)}%</div>
                    <div class="trading-stat-label">Win Rate</div>
                </div>
                <div class="trading-stat">
                    <div class="trading-stat-value ${totalPnlAfterFees >= 0 ? 'positive' : 'negative'}">$${totalPnlAfterFees.toFixed(2)}</div>
                    <div class="trading-stat-label">Net P&L</div>
                </div>
            `;
        }

        // Watchlist functions
        function addToWatchlist(symbol) {
            watchlist.add(symbol);
            saveToStorage();
            updateWatchlistDisplay();
            updateDashboard();
            showAlert(`${symbol} added to watchlist`, 'success');
        }

        function removeFromWatchlist(symbol) {
            watchlist.delete(symbol);
            saveToStorage();
            updateWatchlistDisplay();
            updateDashboard();
            showAlert(`${symbol} removed from watchlist`, 'info');
        }

        function addCustomSymbol() {
            const symbol = prompt('Enter symbol to add to watchlist (e.g., BTCUSDT):');
            if (symbol && symbol.trim()) {
                const cleanSymbol = symbol.trim().toUpperCase();
                if (!cleanSymbol.endsWith('USDT')) {
                    showAlert('Please use USDT pairs only', 'warning');
                    return;
                }
                addToWatchlist(cleanSymbol);
            }
        }

        function clearWatchlist() {
            if (watchlist.size === 0) return;
            if (confirm('Clear all watchlist items?')) {
                watchlist.clear();
                saveToStorage();
                updateWatchlistDisplay();
                updateDashboard();
                showAlert('Watchlist cleared', 'info');
            }
        }

        // Trade History Functions
        function updateTradeHistory() {
            // Update history from active trades
            tradeHistory = activeTrades.filter(t => t.closed);
            
            // Update symbol filter options
            updateHistoryFilters();
            
            // Get filters
            const symbolFilter = document.getElementById('historySymbolFilter').value;
            const statusFilter = document.getElementById('historyStatusFilter').value;
            const sideFilter = document.getElementById('historySideFilter').value;
            const dateFrom = document.getElementById('historyDateFrom').value;
            const dateTo = document.getElementById('historyDateTo').value;
            
            // Filter trades
            let filteredTrades = [...tradeHistory];
            
            if (symbolFilter) {
                filteredTrades = filteredTrades.filter(t => t.symbol === symbolFilter);
            }
            
            if (statusFilter) {
                filteredTrades = filteredTrades.filter(t => t.status === statusFilter);
            }
            
            if (sideFilter) {
                filteredTrades = filteredTrades.filter(t => t.side === sideFilter);
            }
            
            if (dateFrom) {
                const fromDate = new Date(dateFrom);
                filteredTrades = filteredTrades.filter(t => new Date(t.entryTime) >= fromDate);
            }
            
            if (dateTo) {
                const toDate = new Date(dateTo);
                toDate.setHours(23, 59, 59, 999);
                filteredTrades = filteredTrades.filter(t => new Date(t.entryTime) <= toDate);
            }
            
            // Sort by exit time (most recent first)
            filteredTrades.sort((a, b) => new Date(b.exitTime) - new Date(a.exitTime));
            
            // Update summary
            updateTradeHistorySummary(filteredTrades);
            
            // Update table
            const tbody = document.getElementById('tradeHistoryBody');
            
            if (filteredTrades.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="12" class="empty-state">
                            <div class="empty-state-icon">
                                <i class="fas fa-history"></i>
                            </div>
                            <div class="empty-state-title">No Trade History</div>
                            <div class="empty-state-description">
                                Your closed trades will appear here
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            filteredTrades.forEach(trade => {
                const entryTime = new Date(trade.entryTime);
                const exitTime = new Date(trade.exitTime);
                const pnlClass = trade.pnl >= 0 ? 'positive' : 'negative';
                const pnlPercentClass = trade.pnlPercent >= 0 ? 'positive' : 'negative';
                const statusClass = trade.status;
                const statusText = trade.status === 'closed_stop_limit' ? 'Stop Limit' : 
                                 trade.status.replace('closed_', '').toUpperCase();
                
                html += `
                    <tr>
                        <td>
                            <div class="coin-cell">
                                <div class="coin-icon" style="width: 24px; height: 24px; font-size: 10px;">${trade.symbol.replace('USDT', '').substring(0, 3)}</div>
                                <div class="coin-symbol">${trade.symbol}</div>
                            </div>
                        </td>
                        <td>
                            <span class="trade-side ${trade.side}">${trade.side.toUpperCase()}</span>
                        </td>
                        <td>$${trade.entryPrice.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 8})}</td>
                        <td>$${(trade.exitPrice || trade.entryPrice).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 8})}</td>
                        <td>$${trade.size.toFixed(2)}</td>
                        <td>${trade.leverage}x</td>
                        <td class="${pnlClass}">${trade.pnl >= 0 ? '+' : ''}$${trade.pnl.toFixed(2)}</td>
                        <td class="${pnlPercentClass}">${trade.pnlPercent >= 0 ? '+' : ''}${trade.pnlPercent.toFixed(2)}%</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>${entryTime.toLocaleString()}</td>
                        <td>${exitTime.toLocaleString()}</td>
                        <td>${trade.duration || 'N/A'}</td>
                    </tr>
                `;
            });
            
            tbody.innerHTML = html;
        }

        function updateTradeHistorySummary(trades) {
            const totalTrades = trades.length;
            const winningTrades = trades.filter(t => t.pnl > 0).length;
            const losingTrades = trades.filter(t => t.pnl <= 0).length;
            const totalPnl = trades.reduce((sum, t) => sum + t.pnl, 0);
            const totalFees = trades.reduce((sum, t) => sum + (t.totalFees || 0), 0);
            const winRate = totalTrades > 0 ? (winningTrades / totalTrades) * 100 : 0;
            
            const summaryHtml = `
                <div class="history-stat">
                    <div class="history-stat-value">${totalTrades}</div>
                    <div class="history-stat-label">Total Trades</div>
                </div>
                <div class="history-stat">
                    <div class="history-stat-value ${winRate >= 50 ? 'positive' : 'negative'}">${winRate.toFixed(1)}%</div>
                    <div class="history-stat-label">Win Rate</div>
                </div>
                <div class="history-stat">
                    <div class="history-stat-value ${totalPnl >= 0 ? 'positive' : 'negative'}">$${totalPnl.toFixed(2)}</div>
                    <div class="history-stat-label">Total P&L</div>
                </div>
                <div class="history-stat">
                    <div class="history-stat-value">$${totalFees.toFixed(2)}</div>
                    <div class="history-stat-label">Total Fees</div>
                </div>
            `;
            
            document.getElementById('tradeHistorySummary').innerHTML = summaryHtml;
        }

        function updateHistoryFilters() {
            const symbolFilter = document.getElementById('historySymbolFilter');
            const uniqueSymbols = [...new Set(tradeHistory.map(t => t.symbol))].sort();
            
            // Clear existing options (keep "All Symbols")
            while (symbolFilter.options.length > 1) {
                symbolFilter.remove(1);
            }
            
            // Add symbol options
            uniqueSymbols.forEach(symbol => {
                const option = document.createElement('option');
                option.value = symbol;
                option.textContent = symbol;
                symbolFilter.appendChild(option);
            });
        }

        function clearHistoryFilters() {
            document.getElementById('historySymbolFilter').value = '';
            document.getElementById('historyStatusFilter').value = '';
            document.getElementById('historySideFilter').value = '';
            document.getElementById('historyDateFrom').value = '';
            document.getElementById('historyDateTo').value = '';
            updateTradeHistory();
        }

        // Utility functions
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(tabBtn => tabBtn.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(navBtn => navBtn.classList.remove('active'));
            
            document.getElementById(tabName + 'Tab').classList.add('active');
            document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
            document.querySelector(`.nav-btn[onclick="switchTab('${tabName}')"]`).classList.add('active');
            
            if (tabName === 'trading') {
                updateTradeCalculations();
                calculateFees();
            } else if (tabName === 'watchlist') {
                updateWatchlistDisplay();
            } else if (tabName === 'history') {
                updateTradeHistory();
            } else if (tabName === 'settings') {
                // Check if settings have been changed
                if (settingsChanged) {
                    updateSettingsStatus('Settings have been modified. Click Save to apply.', 'warning');
                }
            }
        }

        function updateLeverageValue(value) {
            document.getElementById('leverageValue').textContent = value + 'x';
            document.getElementById('tradeLeverage').value = value;
        }

        function resetTradeForm() {
            document.getElementById('tradeComment').value = '';
            document.getElementById('tradeSize').value = '100';
            document.getElementById('takeProfit').value = document.getElementById('defaultTP').value || '10';
            document.getElementById('stopLoss').value = document.getElementById('defaultSL').value || '5';
            
            const defaultLeverage = document.getElementById('defaultLeverage').value || '10';
            updateLeverageValue(defaultLeverage);
            
            const defaultMarginAllocation = document.getElementById('defaultMarginAllocation').value || '10';
            updateMarginAllocationValue(defaultMarginAllocation);
            
            document.getElementById('feeDisplay').style.display = 'none';
            
            // Reset to market order
            setOrderType('market');
            
            // Reset to default margin mode
            const defaultMarginMode = document.getElementById('defaultMarginMode').value || 'isolated';
            setMarginMode(defaultMarginMode);
            
            // Clear stop limit fields
            document.getElementById('stopPrice').value = '';
            document.getElementById('stopLimitPrice').value = '';
        }

        function updateTradeCalculations() {
            if (selectedSymbol) {
                const marketItem = currentMarketData.find(item => item.symbol === selectedSymbol);
                if (marketItem) {
                    document.getElementById('entryPrice').value = parseFloat(marketItem.lastPrice);
                    if (orderType === 'limit') {
                        document.getElementById('limitPrice').value = parseFloat(marketItem.lastPrice);
                    }
                    if (orderType === 'stop_limit') {
                        updateStopLimitPrices();
                    }
                }
            }
        }

        function updateAllTrades() {
            updateLivePnl();
            updateTradesDisplay();
            showAlert('All trades updated', 'info');
        }

        function filterTable(tableId, searchTerm) {
            const search = searchTerm.toUpperCase();
            const table = document.getElementById(tableId);
            const rows = table.getElementsByTagName('tr');
            
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                if (row.textContent.toUpperCase().indexOf(search) > -1) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            }
        }

        // Alert system with cooldown
        function showAlert(message, type = 'info') {
            // Check if alerts are enabled
            const soundAlertEnabled = document.getElementById('soundAlert').checked;
            const priceAlertEnabled = document.getElementById('priceAlert').checked;
            const tpslAlertEnabled = document.getElementById('tpslAlert').checked;
            
            // Determine if we should show this alert based on type and settings
            let shouldShowAlert = true;
            
            if (type === 'info' && !priceAlertEnabled) {
                shouldShowAlert = false;
            } else if ((type === 'success' || type === 'warning' || type === 'danger') && 
                      (type.includes('tp') || type.includes('sl')) && !tpslAlertEnabled) {
                shouldShowAlert = false;
            }
            
            if (!shouldShowAlert) {
                return;
            }
            
            const alert = document.getElementById('alert');
            const alertMessage = document.getElementById('alertMessage');
            
            alertMessage.textContent = message;
            alert.className = `alert ${type}`;
            alert.style.display = 'flex';
            
            if (soundAlertEnabled && type !== 'info') {
                playAlertSound();
            }
            
            setTimeout(() => {
                if (alert.style.display !== 'none') {
                    alert.style.display = 'none';
                }
            }, 5000);
        }

        function closeAlert() {
            document.getElementById('alert').style.display = 'none';
        }

        function playAlertSound() {
            const audio = new Audio('https://assets.mixkit.co/sfx/preview/mixkit-winning-chimes-2015.mp3');
            audio.volume = 0.3;
            audio.play().catch(e => console.log('Audio play failed:', e));
        }

        // Event listeners
        function setupEventListeners() {
            document.getElementById('tradeLeverage').addEventListener('input', function() {
                updateLeverageValue(this.value);
                calculateFees();
            });
            
            document.getElementById('marginAllocation').addEventListener('input', function() {
                updateMarginAllocationValue(this.value);
                calculateFees();
            });
            
            document.getElementById('refreshRate').addEventListener('change', function() {
                settingsChanged = true;
                updateSettingsStatus('Settings have been modified. Click Save to apply.', 'warning');
            });
            
            document.getElementById('autoRefresh').addEventListener('change', function() {
                settingsChanged = true;
                updateSettingsStatus('Settings have been modified. Click Save to apply.', 'warning');
            });
            
            document.getElementById('availableMarginInput').addEventListener('change', function() {
                updateAvailableMargin();
            });
            
            // Input listeners for fee calculation
            ['entryPrice', 'tradeSize', 'takeProfit', 'tradeSide', 'limitPrice', 'stopPrice', 'stopLimitPrice'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', calculateFees);
                    element.addEventListener('change', calculateFees);
                }
            });
            
            // Update stop limit info when prices change
            document.getElementById('stopPrice').addEventListener('input', updateStopLimitInfo);
            document.getElementById('stopLimitPrice').addEventListener('input', updateStopLimitInfo);
            
            // Update stop limit prices when trade side changes
            document.getElementById('tradeSide').addEventListener('change', function() {
                if (orderType === 'stop_limit') {
                    updateStopLimitPrices();
                }
            });
            
            // Close search results when clicking elsewhere
            document.addEventListener('click', function(event) {
                if (!event.target.closest('.search-container')) {
                    document.getElementById('searchResults').style.display = 'none';
                }
            });
        }

        // Initialize settings from saved values
        function updateDashboard() {
            const activeCount = activeTrades.filter(t => !t.closed).length;
            const pendingCount = pendingOrders.length;
            document.getElementById('activeTradesCount').textContent = activeCount + pendingCount;
            
            // Always update today's P&L
            updateTodayPnlDisplay();
        }
   
        
    </script>
</body>
</html>
